version: '3.8'\n\nservices:\n  # Prometheus\n  prometheus:\n    image: prom/prometheus:latest\n    container_name: nexus-prometheus\n    ports:\n      - \"9090:9090\"\n    volumes:\n      - ./prometheus.yml:/etc/prometheus/prometheus.yml\n      - ./alert_rules.yml:/etc/prometheus/alert_rules.yml\n      - prometheus_data:/prometheus\n    command:\n      - '--config.file=/etc/prometheus/prometheus.yml'\n      - '--storage.tsdb.path=/prometheus'\n      - '--storage.tsdb.retention.time=30d'\n    networks:\n      - monitoring\n    restart: unless-stopped\n    healthcheck:\n      test: [\"CMD\", \"wget\", \"--quiet\", \"--tries=1\", \"--spider\", \"http://localhost:9090/-/healthy\"]\n      interval: 10s\n      timeout: 5s\n      retries: 3\n\n  # Grafana\n  grafana:\n    image: grafana/grafana:latest\n    container_name: nexus-grafana\n    ports:\n      - \"3000:3000\"\n    environment:\n      - GF_SECURITY_ADMIN_USER=admin\n      - GF_SECURITY_ADMIN_PASSWORD=admin123\n      - GF_INSTALL_PLUGINS=grafana-piechart-panel\n    volumes:\n      - grafana_data:/var/lib/grafana\n      - ./grafana-dashboard.json:/etc/grafana/provisioning/dashboards/nexus.json\n    networks:\n      - monitoring\n    restart: unless-stopped\n    depends_on:\n      - prometheus\n    healthcheck:\n      test: [\"CMD\", \"wget\", \"--quiet\", \"--tries=1\", \"--spider\", \"http://localhost:3000/api/health\"]\n      interval: 10s\n      timeout: 5s\n      retries: 3\n\n  # Alertmanager\n  alertmanager:\n    image: prom/alertmanager:latest\n    container_name: nexus-alertmanager\n    ports:\n      - \"9093:9093\"\n    volumes:\n      - ./alertmanager.yml:/etc/alertmanager/alertmanager.yml\n      - alertmanager_data:/alertmanager\n    command:\n      - '--config.file=/etc/alertmanager/alertmanager.yml'\n      - '--storage.path=/alertmanager'\n    networks:\n      - monitoring\n    restart: unless-stopped\n    healthcheck:\n      test: [\"CMD\", \"wget\", \"--quiet\", \"--tries=1\", \"--spider\", \"http://localhost:9093/-/healthy\"]\n      interval: 10s\n      timeout: 5s\n      retries: 3\n\n  # Node Exporter (系統指標)\n  node-exporter:\n    image: prom/node-exporter:latest\n    container_name: nexus-node-exporter\n    ports:\n      - \"9100:9100\"\n    volumes:\n      - /proc:/host/proc:ro\n      - /sys:/host/sys:ro\n      - /:/rootfs:ro\n    command:\n      - '--path.procfs=/host/proc'\n      - '--path.sysfs=/host/sys'\n      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'\n    networks:\n      - monitoring\n    restart: unless-stopped\n\n  # cAdvisor (容器指標)\n  cadvisor:\n    image: gcr.io/cadvisor/cadvisor:latest\n    container_name: nexus-cadvisor\n    ports:\n      - \"8080:8080\"\n    volumes:\n      - /:/rootfs:ro\n      - /var/run:/var/run:ro\n      - /sys:/sys:ro\n      - /var/lib/docker/:/var/lib/docker:ro\n    networks:\n      - monitoring\n    restart: unless-stopped\n    privileged: true\n\nvolumes:\n  prometheus_data:\n    driver: local\n  grafana_data:\n    driver: local\n  alertmanager_data:\n    driver: local\n\nnetworks:\n  monitoring:\n    driver: bridge\n
