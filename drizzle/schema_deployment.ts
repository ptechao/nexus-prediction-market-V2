/**\n * Drizzle ORM Schema - 部署相關表\n * \n * 定義部署日誌、告警和審計日誌表。\n */\n\nimport {\n  mysqlTable,\n  varchar,\n  text,\n  timestamp,\n  int,\n  decimal,\n  enum as mysqlEnum,\n  boolean,\n  index,\n  primaryKey,\n  foreignKey,\n} from 'drizzle-orm/mysql-core';\nimport { sql } from 'drizzle-orm';\n\n/**\n * 部署日誌表\n * \n * 記錄所有智能合約部署的詳細信息。\n */\nexport const deploymentLogs = mysqlTable(\n  'deployment_logs',\n  {\n    id: varchar('id', { length: 36 }).primaryKey().default(sql`UUID()`),\n    deploymentId: varchar('deployment_id', { length: 36 }).notNull(),\n    type: mysqlEnum('type', ['BinaryMarket', 'CopyTradingVault']).notNull(),\n    status: mysqlEnum('status', ['pending', 'processing', 'completed', 'failed']).notNull(),\n    contractAddress: varchar('contract_address', { length: 42 }),\n    transactionHash: varchar('transaction_hash', { length: 66 }),\n    blockNumber: int('block_number'),\n    gasUsed: decimal('gas_used', { precision: 20, scale: 0 }),\n    gasPriceFinal: decimal('gas_price_final', { precision: 20, scale: 0 }),\n    totalCostWei: decimal('total_cost_wei', { precision: 30, scale: 0 }),\n    totalCostUsd: decimal('total_cost_usd', { precision: 10, scale: 2 }),\n    deploymentDuration: int('deployment_duration'), // 秒\n    confirmationTime: int('confirmation_time'), // 秒\n    confirmations: int('confirmations'),\n    errorMessage: text('error_message'),\n    retryCount: int('retry_count').default(0),\n    parameters: text('parameters'), // JSON\n    metadata: text('metadata'), // JSON\n    createdAt: timestamp('created_at').defaultNow(),\n    updatedAt: timestamp('updated_at').defaultNow().onUpdateNow(),\n    completedAt: timestamp('completed_at'),\n  },\n  (table) => ({\n    deploymentIdIdx: index('idx_deployment_id').on(table.deploymentId),\n    statusIdx: index('idx_status').on(table.status),\n    contractAddressIdx: index('idx_contract_address').on(table.contractAddress),\n    transactionHashIdx: index('idx_transaction_hash').on(table.transactionHash),\n    createdAtIdx: index('idx_created_at').on(table.createdAt),\n    typeStatusIdx: index('idx_type_status').on(table.type, table.status),\n  })\n);\n\n/**\n * 告警表\n * \n * 記錄系統生成的所有告警。\n */\nexport const alerts = mysqlTable(\n  'alerts',\n  {\n    id: varchar('id', { length: 36 }).primaryKey().default(sql`UUID()`),\n    title: varchar('title', { length: 256 }).notNull(),\n    description: text('description').notNull(),\n    level: mysqlEnum('level', ['INFO', 'WARNING', 'CRITICAL']).notNull(),\n    status: mysqlEnum('status', ['ACTIVE', 'ACKNOWLEDGED', 'RESOLVED']).notNull(),\n    source: varchar('source', { length: 100 }).notNull(),\n    sourceId: varchar('source_id', { length: 36 }),\n    category: varchar('category', { length: 50 }).notNull(),\n    tags: varchar('tags', { length: 500 }), // 逗號分隔\n    priority: int('priority').default(0), // 0-100\n    acknowledgedBy: varchar('acknowledged_by', { length: 36 }),\n    acknowledgedAt: timestamp('acknowledged_at'),\n    resolvedBy: varchar('resolved_by', { length: 36 }),\n    resolvedAt: timestamp('resolved_at'),\n    escalationCount: int('escalation_count').default(0),\n    lastEscalatedAt: timestamp('last_escalated_at'),\n    notificationChannels: varchar('notification_channels', { length: 200 }), // JSON\n    metadata: text('metadata'), // JSON\n    createdAt: timestamp('created_at').defaultNow(),\n    updatedAt: timestamp('updated_at').defaultNow().onUpdateNow(),\n  },\n  (table) => ({\n    levelIdx: index('idx_level').on(table.level),\n    statusIdx: index('idx_status').on(table.status),\n    sourceIdx: index('idx_source').on(table.source),\n    categoryIdx: index('idx_category').on(table.category),\n    createdAtIdx: index('idx_created_at').on(table.createdAt),\n    levelStatusIdx: index('idx_level_status').on(table.level, table.status),\n    sourceIdIdx: index('idx_source_id').on(table.sourceId),\n  })\n);\n\n/**\n * 審計日誌表\n * \n * 記錄所有系統操作和更改。\n */\nexport const auditLogs = mysqlTable(\n  'audit_logs',\n  {\n    id: varchar('id', { length: 36 }).primaryKey().default(sql`UUID()`),\n    userId: varchar('user_id', { length: 36 }),\n    action: varchar('action', { length: 100 }).notNull(),\n    resource: varchar('resource', { length: 100 }).notNull(),\n    resourceId: varchar('resource_id', { length: 36 }).notNull(),\n    status: mysqlEnum('status', ['success', 'failure']).notNull(),\n    statusCode: int('status_code'),\n    method: varchar('method', { length: 10 }), // GET, POST, PUT, DELETE\n    endpoint: varchar('endpoint', { length: 500 }),\n    ipAddress: varchar('ip_address', { length: 45 }),\n    userAgent: varchar('user_agent', { length: 500 }),\n    requestData: text('request_data'), // JSON\n    responseData: text('response_data'), // JSON\n    errorMessage: text('error_message'),\n    duration: int('duration'), // 毫秒\n    metadata: text('metadata'), // JSON\n    createdAt: timestamp('created_at').defaultNow(),\n  },\n  (table) => ({\n    userIdIdx: index('idx_user_id').on(table.userId),\n    actionIdx: index('idx_action').on(table.action),\n    resourceIdx: index('idx_resource').on(table.resource),\n    resourceIdIdx: index('idx_resource_id').on(table.resourceId),\n    statusIdx: index('idx_status').on(table.status),\n    createdAtIdx: index('idx_created_at').on(table.createdAt),\n    actionResourceIdx: index('idx_action_resource').on(table.action, table.resource),\n  })\n);\n\n/**\n * 部署統計表\n * \n * 存儲聚合的部署統計數據。\n */\nexport const deploymentStats = mysqlTable(\n  'deployment_stats',\n  {\n    id: varchar('id', { length: 36 }).primaryKey().default(sql`UUID()`),\n    date: timestamp('date').notNull(),\n    type: mysqlEnum('type', ['BinaryMarket', 'CopyTradingVault', 'ALL']).notNull(),\n    totalDeployments: int('total_deployments').default(0),\n    successfulDeployments: int('successful_deployments').default(0),\n    failedDeployments: int('failed_deployments').default(0),\n    pendingDeployments: int('pending_deployments').default(0),\n    successRate: decimal('success_rate', { precision: 5, scale: 2 }).default(0),\n    averageDuration: decimal('average_duration', { precision: 10, scale: 2 }).default(0),\n    averageGasUsed: decimal('average_gas_used', { precision: 20, scale: 0 }).default(0),\n    averageCostUsd: decimal('average_cost_usd', { precision: 10, scale: 2 }).default(0),\n    minCostUsd: decimal('min_cost_usd', { precision: 10, scale: 2 }),\n    maxCostUsd: decimal('max_cost_usd', { precision: 10, scale: 2 }),\n    totalCostUsd: decimal('total_cost_usd', { precision: 15, scale: 2 }).default(0),\n    createdAt: timestamp('created_at').defaultNow(),\n    updatedAt: timestamp('updated_at').defaultNow().onUpdateNow(),\n  },\n  (table) => ({\n    dateIdx: index('idx_date').on(table.date),\n    typeIdx: index('idx_type').on(table.type),\n    dateTypeIdx: index('idx_date_type').on(table.date, table.type),\n  })\n);\n\n/**\n * 告警統計表\n * \n * 存儲聚合的告警統計數據。\n */\nexport const alertStats = mysqlTable(\n  'alert_stats',\n  {\n    id: varchar('id', { length: 36 }).primaryKey().default(sql`UUID()`),\n    date: timestamp('date').notNull(),\n    level: mysqlEnum('level', ['INFO', 'WARNING', 'CRITICAL', 'ALL']).notNull(),\n    source: varchar('source', { length: 100 }).notNull(),\n    totalAlerts: int('total_alerts').default(0),\n    activeAlerts: int('active_alerts').default(0),\n    acknowledgedAlerts: int('acknowledged_alerts').default(0),\n    resolvedAlerts: int('resolved_alerts').default(0),\n    averageResponseTime: decimal('average_response_time', { precision: 10, scale: 2 }).default(0),\n    maxResponseTime: decimal('max_response_time', { precision: 10, scale: 2 }),\n    minResponseTime: decimal('min_response_time', { precision: 10, scale: 2 }),\n    createdAt: timestamp('created_at').defaultNow(),\n    updatedAt: timestamp('updated_at').defaultNow().onUpdateNow(),\n  },\n  (table) => ({\n    dateIdx: index('idx_date').on(table.date),\n    levelIdx: index('idx_level').on(table.level),\n    sourceIdx: index('idx_source').on(table.source),\n    dateLevelIdx: index('idx_date_level').on(table.date, table.level),\n  })\n);\n\n/**\n * 導出所有表\n */\nexport const deploymentTables = {\n  deploymentLogs,\n  alerts,\n  auditLogs,\n  deploymentStats,\n  alertStats,\n};\n
