# 數據庫集成指南\n\n## 概述\n\n本文檔描述 NEXUS 應用的數據庫集成，包括部署日誌、告警和審計日誌的持久化。\n\n---\n\n## 數據庫架構\n\n### 表結構\n\n#### 1. `deployment_logs` - 部署日誌表\n\n記錄所有智能合約部署的詳細信息。\n\n| 欄位 | 類型 | 描述 |\n|------|------|------|\n| `id` | VARCHAR(36) | 主鍵 (UUID) |\n| `deployment_id` | VARCHAR(36) | 部署 ID |\n| `type` | ENUM | 合約類型 (BinaryMarket, CopyTradingVault) |\n| `status` | ENUM | 部署狀態 (pending, processing, completed, failed) |\n| `contract_address` | VARCHAR(42) | 合約地址 |\n| `transaction_hash` | VARCHAR(66) | 交易哈希 |\n| `block_number` | INT | 區塊號 |\n| `gas_used` | DECIMAL(20,0) | 使用的 Gas |\n| `gas_price_final` | DECIMAL(20,0) | 最終 Gas 價格 |\n| `total_cost_wei` | DECIMAL(30,0) | 總成本 (Wei) |\n| `total_cost_usd` | DECIMAL(10,2) | 總成本 (USD) |\n| `deployment_duration` | INT | 部署耗時 (秒) |\n| `confirmation_time` | INT | 確認耗時 (秒) |\n| `confirmations` | INT | 確認數 |\n| `error_message` | TEXT | 錯誤信息 |\n| `retry_count` | INT | 重試次數 |\n| `parameters` | TEXT | 部署參數 (JSON) |\n| `metadata` | TEXT | 元數據 (JSON) |\n| `created_at` | TIMESTAMP | 創建時間 |\n| `updated_at` | TIMESTAMP | 更新時間 |\n| `completed_at` | TIMESTAMP | 完成時間 |\n\n**索引**:\n- `idx_deployment_id` - 部署 ID\n- `idx_status` - 狀態\n- `idx_contract_address` - 合約地址\n- `idx_transaction_hash` - 交易哈希\n- `idx_created_at` - 創建時間\n- `idx_type_status` - 類型和狀態組合\n\n#### 2. `alerts` - 告警表\n\n記錄系統生成的所有告警。\n\n| 欄位 | 類型 | 描述 |\n|------|------|------|\n| `id` | VARCHAR(36) | 主鍵 (UUID) |\n| `title` | VARCHAR(256) | 告警標題 |\n| `description` | TEXT | 告警描述 |\n| `level` | ENUM | 告警級別 (INFO, WARNING, CRITICAL) |\n| `status` | ENUM | 告警狀態 (ACTIVE, ACKNOWLEDGED, RESOLVED) |\n| `source` | VARCHAR(100) | 告警來源 |\n| `source_id` | VARCHAR(36) | 來源 ID |\n| `category` | VARCHAR(50) | 告警類別 |\n| `tags` | VARCHAR(500) | 標籤 (逗號分隔) |\n| `priority` | INT | 優先級 (0-100) |\n| `acknowledged_by` | VARCHAR(36) | 確認者 ID |\n| `acknowledged_at` | TIMESTAMP | 確認時間 |\n| `resolved_by` | VARCHAR(36) | 解決者 ID |\n| `resolved_at` | TIMESTAMP | 解決時間 |\n| `escalation_count` | INT | 升級次數 |\n| `last_escalated_at` | TIMESTAMP | 最後升級時間 |\n| `notification_channels` | VARCHAR(200) | 通知渠道 (JSON) |\n| `metadata` | TEXT | 元數據 (JSON) |\n| `created_at` | TIMESTAMP | 創建時間 |\n| `updated_at` | TIMESTAMP | 更新時間 |\n\n**索引**:\n- `idx_level` - 告警級別\n- `idx_status` - 告警狀態\n- `idx_source` - 告警來源\n- `idx_category` - 告警類別\n- `idx_created_at` - 創建時間\n- `idx_level_status` - 級別和狀態組合\n- `idx_source_id` - 來源 ID\n\n#### 3. `audit_logs` - 審計日誌表\n\n記錄所有系統操作和更改。\n\n| 欄位 | 類型 | 描述 |\n|------|------|------|\n| `id` | VARCHAR(36) | 主鍵 (UUID) |\n| `user_id` | VARCHAR(36) | 用戶 ID |\n| `action` | VARCHAR(100) | 操作類型 |\n| `resource` | VARCHAR(100) | 資源類型 |\n| `resource_id` | VARCHAR(36) | 資源 ID |\n| `status` | ENUM | 操作狀態 (success, failure) |\n| `status_code` | INT | HTTP 狀態碼 |\n| `method` | VARCHAR(10) | HTTP 方法 |\n| `endpoint` | VARCHAR(500) | API 端點 |\n| `ip_address` | VARCHAR(45) | IP 地址 |\n| `user_agent` | VARCHAR(500) | User Agent |\n| `request_data` | TEXT | 請求數據 (JSON) |\n| `response_data` | TEXT | 響應數據 (JSON) |\n| `error_message` | TEXT | 錯誤信息 |\n| `duration` | INT | 操作耗時 (毫秒) |\n| `metadata` | TEXT | 元數據 (JSON) |\n| `created_at` | TIMESTAMP | 創建時間 |\n\n**索引**:\n- `idx_user_id` - 用戶 ID\n- `idx_action` - 操作類型\n- `idx_resource` - 資源類型\n- `idx_resource_id` - 資源 ID\n- `idx_status` - 操作狀態\n- `idx_created_at` - 創建時間\n- `idx_action_resource` - 操作和資源組合\n\n#### 4. `deployment_stats` - 部署統計表\n\n存儲聚合的部署統計數據。\n\n| 欄位 | 類型 | 描述 |\n|------|------|------|\n| `id` | VARCHAR(36) | 主鍵 (UUID) |\n| `date` | TIMESTAMP | 統計日期 |\n| `type` | ENUM | 合約類型 (BinaryMarket, CopyTradingVault, ALL) |\n| `total_deployments` | INT | 總部署數 |\n| `successful_deployments` | INT | 成功部署數 |\n| `failed_deployments` | INT | 失敗部署數 |\n| `pending_deployments` | INT | 待處理部署數 |\n| `success_rate` | DECIMAL(5,2) | 成功率 (%) |\n| `average_duration` | DECIMAL(10,2) | 平均耗時 (秒) |\n| `average_gas_used` | DECIMAL(20,0) | 平均 Gas 使用 |\n| `average_cost_usd` | DECIMAL(10,2) | 平均成本 (USD) |\n| `min_cost_usd` | DECIMAL(10,2) | 最小成本 (USD) |\n| `max_cost_usd` | DECIMAL(10,2) | 最大成本 (USD) |\n| `total_cost_usd` | DECIMAL(15,2) | 總成本 (USD) |\n| `created_at` | TIMESTAMP | 創建時間 |\n| `updated_at` | TIMESTAMP | 更新時間 |\n\n#### 5. `alert_stats` - 告警統計表\n\n存儲聚合的告警統計數據。\n\n| 欄位 | 類型 | 描述 |\n|------|------|------|\n| `id` | VARCHAR(36) | 主鍵 (UUID) |\n| `date` | TIMESTAMP | 統計日期 |\n| `level` | ENUM | 告警級別 (INFO, WARNING, CRITICAL, ALL) |\n| `source` | VARCHAR(100) | 告警來源 |\n| `total_alerts` | INT | 總告警數 |\n| `active_alerts` | INT | 活躍告警數 |\n| `acknowledged_alerts` | INT | 已確認告警數 |\n| `resolved_alerts` | INT | 已解決告警數 |\n| `average_response_time` | DECIMAL(10,2) | 平均響應時間 (秒) |\n| `max_response_time` | DECIMAL(10,2) | 最大響應時間 (秒) |\n| `min_response_time` | DECIMAL(10,2) | 最小響應時間 (秒) |\n| `created_at` | TIMESTAMP | 創建時間 |\n| `updated_at` | TIMESTAMP | 更新時間 |\n\n---\n\n## 使用指南\n\n### 1. 應用遷移\n\n#### 方式 1：使用 Drizzle Kit（推薦）\n\n```bash\ncd /home/ubuntu/nexus-prediction-market-v2\npnpm drizzle-kit generate\npnpm drizzle-kit migrate\n```\n\n#### 方式 2：手動執行 SQL\n\n```bash\nmysql -u root -p < drizzle/0001_deployment_tables.sql\n```\n\n#### 方式 3：通過管理 UI\n\n在 Manus 管理 UI 的 Database 面板中執行 SQL。\n\n### 2. 使用 DeploymentLogger 服務\n\n```typescript\nimport deploymentLogger from './server/services/deploymentLogger';\n\n// 記錄部署\nawait deploymentLogger.logDeployment({\n  deploymentId: 'deploy-123',\n  type: 'BinaryMarket',\n  status: 'completed',\n  contractAddress: '0x...',\n  transactionHash: '0x...',\n  totalCostUsd: 125.50,\n});\n\n// 記錄告警\nawait deploymentLogger.logAlert({\n  title: 'High Gas Price',\n  description: 'Gas price exceeded 100 Gwei',\n  level: 'WARNING',\n  source: 'gas-monitor',\n  category: 'gas',\n});\n\n// 獲取部署日誌\nconst logs = await deploymentLogger.getDeploymentLogs({\n  type: 'BinaryMarket',\n  status: 'completed',\n  limit: 20,\n});\n\n// 獲取活躍告警\nconst alerts = await deploymentLogger.getActiveAlerts({\n  level: 'CRITICAL',\n  limit: 10,\n});\n\n// 確認告警\nawait deploymentLogger.acknowledgeAlert('alert-123', 'user-456');\n```\n\n### 3. 使用 tRPC 路由\n\n```typescript\n// 獲取部署日誌\nconst logs = await trpc.deploymentPersistence.getDeploymentLogs.query({\n  type: 'BinaryMarket',\n  limit: 20,\n});\n\n// 獲取活躍告警\nconst alerts = await trpc.deploymentPersistence.getActiveAlerts.query({\n  level: 'CRITICAL',\n});\n\n// 確認告警\nawait trpc.deploymentPersistence.acknowledgeAlert.mutate({\n  alertId: 'alert-123',\n});\n```\n\n---\n\n## 性能優化\n\n### 1. 索引策略\n\n所有表都包含以下索引以優化查詢性能：\n\n- **單列索引**：用於常見過濾條件（status、level、source 等）\n- **複合索引**：用於常見組合查詢（type + status、level + status 等）\n- **時間索引**：用於時間範圍查詢\n\n### 2. 查詢優化\n\n```typescript\n// ✅ 好：使用索引的查詢\nawait db\n  .select()\n  .from(deploymentLogs)\n  .where(eq(deploymentLogs.status, 'completed'))\n  .limit(20);\n\n// ❌ 差：全表掃描\nawait db\n  .select()\n  .from(deploymentLogs)\n  .where(sql`JSON_EXTRACT(parameters, '$.key') = 'value'`)\n  .limit(20);\n```\n\n### 3. 數據歸檔\n\n建議定期歸檔舊數據以保持表大小：\n\n```sql\n-- 歸檔 30 天前的部署日誌\nINSERT INTO deployment_logs_archive\nSELECT * FROM deployment_logs\nWHERE created_at < DATE_SUB(NOW(), INTERVAL 30 DAY);\n\nDELETE FROM deployment_logs\nWHERE created_at < DATE_SUB(NOW(), INTERVAL 30 DAY);\n```\n\n---\n\n## 監控和維護\n\n### 1. 表大小監控\n\n```sql\nSELECT\n  TABLE_NAME,\n  ROUND(((data_length + index_length) / 1024 / 1024), 2) AS size_mb\nFROM information_schema.TABLES\nWHERE TABLE_SCHEMA = 'nexus'\nORDER BY size_mb DESC;\n```\n\n### 2. 查詢性能分析\n\n```sql\n-- 啟用慢查詢日誌\nSET GLOBAL slow_query_log = 'ON';\nSET GLOBAL long_query_time = 2;\n\n-- 分析查詢\nEXPLAIN SELECT * FROM deployment_logs WHERE status = 'completed';\n```\n\n### 3. 備份策略\n\n```bash\n# 定期備份\nmysqldump -u root -p nexus > backup_$(date +%Y%m%d).sql\n\n# 恢復備份\nmysql -u root -p nexus < backup_20260301.sql\n```\n\n---\n\n## 故障排查\n\n### 常見問題\n\n#### Q: 部署日誌未保存\n\n**A**: 檢查以下項目：\n1. 確保表已創建：`SHOW TABLES LIKE 'deployment_logs';`\n2. 檢查數據庫連接：`SELECT 1;`\n3. 查看應用日誌：`tail -f .manus-logs/devserver.log`\n\n#### Q: 查詢速度慢\n\n**A**: 檢查以下項目：\n1. 驗證索引存在：`SHOW INDEX FROM deployment_logs;`\n2. 分析查詢計劃：`EXPLAIN SELECT ...;`\n3. 考慮數據歸檔\n\n#### Q: 磁盤空間不足\n\n**A**: 執行以下操作：\n1. 歸檔舊數據\n2. 優化表：`OPTIMIZE TABLE deployment_logs;`\n3. 刪除不需要的備份\n\n---\n\n## 最佳實踐\n\n1. **使用連接池**：配置數據庫連接池以提高性能\n2. **批量操作**：使用批量插入而不是逐行插入\n3. **定期維護**：定期優化表和更新統計信息\n4. **監控告警**：設置數據庫性能告警\n5. **備份計劃**：實施定期備份計劃\n6. **訪問控制**：限制數據庫訪問權限\n\n---\n\n## 相關文檔\n\n- [Drizzle ORM 文檔](https://orm.drizzle.team/)\n- [MySQL 文檔](https://dev.mysql.com/doc/)\n- [性能優化指南](./PERFORMANCE.md)\n
