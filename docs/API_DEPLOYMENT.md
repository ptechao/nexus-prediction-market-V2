# 部署 API 文檔\n\n## 概述\n\n部署 API 提供了部署智能合約、查詢部署狀態和重試失敗部署的功能。所有部署操作都通過 tRPC 路由進行。\n\n---\n\n## 基本信息\n\n**基礎 URL**: `/api/trpc`  \n**認證**: 需要 JWT token（通過 Cookie 自動傳遞）  \n**內容類型**: `application/json`  \n**響應格式**: JSON  \n\n---\n\n## API 端點\n\n### 1. 部署市場\n\n**端點**: `deployMarket`  \n**方法**: POST (tRPC Mutation)  \n**認證**: 必需（protectedProcedure）  \n**描述**: 部署新的二元市場合約到區塊鏈\n\n#### 請求\n\n```typescript\ntrpc.phaseADeployment.deployMarket.mutate({\n  title: string;                    // 市場標題（1-256 字符）\n  description: string;              // 市場描述（1-1000 字符）\n  endDate: Date;                    // 市場結束時間（必須在未來）\n  oracleAddress: string;            // Oracle 地址（0x 開頭的 42 字符地址）\n  initialLiquidity: bigint;         // 初始流動性（Wei 單位）\n  maxGasPrice?: bigint;             // 最大 Gas 價格（可選）\n  gasLimit?: bigint;                // Gas 限額（可選）\n})\n```\n\n#### 響應成功\n\n```json\n{\n  \"success\": true,\n  \"deploymentId\": \"deploy-123e4567-e89b-12d3-a456-426614174000\",\n  \"contractAddress\": \"0x1234567890123456789012345678901234567890\",\n  \"transactionHash\": \"0xabcdef0123456789abcdef0123456789abcdef0123456789abcdef0123456789\",\n  \"blockNumber\": 5123456,\n  \"gasUsed\": 2500000,\n  \"gasPriceFinal\": 25000000000,\n  \"totalCostWei\": \"62500000000000000\",\n  \"totalCostUsd\": 125.50,\n  \"deploymentDuration\": 45,\n  \"confirmations\": 3\n}\n```\n\n#### 響應失敗\n\n```json\n{\n  \"success\": false,\n  \"error\": \"Invalid Oracle address\",\n  \"code\": \"VALIDATION_ERROR\",\n  \"details\": {\n    \"field\": \"oracleAddress\",\n    \"message\": \"Oracle address is not in whitelist\"\n  }\n}\n```\n\n#### 錯誤碼\n\n| 錯誤碼 | HTTP 狀態 | 描述 |\n|--------|----------|------|\n| `VALIDATION_ERROR` | 400 | 參數驗證失敗 |\n| `INVALID_ORACLE` | 400 | Oracle 地址無效或不在白名單中 |\n| `INSUFFICIENT_BALANCE` | 400 | 部署者賬戶餘額不足 |\n| `GAS_PRICE_TOO_HIGH` | 400 | Gas 價格超過最大限額 |\n| `DEPLOYMENT_FAILED` | 500 | 部署失敗（已重試 3 次） |\n| `TIMEOUT` | 504 | 部署超時 |\n| `NETWORK_ERROR` | 503 | 網絡連接錯誤 |\n\n#### 示例\n\n```typescript\n// 使用示例\ntry {\n  const result = await trpc.phaseADeployment.deployMarket.mutate({\n    title: \"Bitcoin Price Prediction\",\n    description: \"Will Bitcoin price exceed $50,000 by end of month?\",\n    endDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),\n    oracleAddress: \"0x1234567890123456789012345678901234567890\",\n    initialLiquidity: ethers.parseEther(\"10\"),\n  });\n\n  console.log(`Market deployed at: ${result.contractAddress}`);\n  console.log(`Total cost: $${result.totalCostUsd}`);\n} catch (error) {\n  console.error(`Deployment failed: ${error.message}`);\n}\n```\n\n---\n\n### 2. 獲取部署狀態\n\n**端點**: `getDeploymentStatus`  \n**方法**: GET (tRPC Query)  \n**認證**: 不需要（publicProcedure）  \n**描述**: 查詢部署的當前狀態\n\n#### 請求\n\n```typescript\ntrpc.phaseADeployment.getDeploymentStatus.query({\n  deploymentId: string;  // 部署 ID\n})\n```\n\n#### 響應\n\n```json\n{\n  \"deploymentId\": \"deploy-123e4567-e89b-12d3-a456-426614174000\",\n  \"type\": \"BinaryMarket\",\n  \"status\": \"completed\",\n  \"contractAddress\": \"0x1234567890123456789012345678901234567890\",\n  \"transactionHash\": \"0xabcdef0123456789abcdef0123456789abcdef0123456789abcdef0123456789\",\n  \"blockNumber\": 5123456,\n  \"gasUsed\": 2500000,\n  \"gasPriceFinal\": 25000000000,\n  \"totalCostWei\": \"62500000000000000\",\n  \"totalCostUsd\": 125.50,\n  \"deploymentDuration\": 45,\n  \"confirmations\": 3,\n  \"createdAt\": \"2026-03-01T10:30:00Z\",\n  \"completedAt\": \"2026-03-01T10:31:00Z\"\n}\n```\n\n#### 狀態值\n\n| 狀態 | 描述 |\n|------|------|\n| `pending` | 等待部署 |\n| `processing` | 部署進行中 |\n| `completed` | 部署成功 |\n| `failed` | 部署失敗 |\n\n#### 示例\n\n```typescript\n// 查詢部署狀態\nconst status = await trpc.phaseADeployment.getDeploymentStatus.query({\n  deploymentId: \"deploy-123e4567-e89b-12d3-a456-426614174000\",\n});\n\nif (status.status === \"completed\") {\n  console.log(`Market deployed successfully at ${status.contractAddress}`);\n} else if (status.status === \"failed\") {\n  console.log(`Deployment failed: ${status.errorMessage}`);\n}\n```\n\n---\n\n### 3. 重試失敗的部署\n\n**端點**: `retryFailedDeployment`  \n**方法**: POST (tRPC Mutation)  \n**認證**: 必需（protectedProcedure）  \n**描述**: 重試失敗的部署\n\n#### 請求\n\n```typescript\ntrpc.phaseADeployment.retryFailedDeployment.mutate({\n  deploymentId: string;  // 失敗的部署 ID\n  maxGasPrice?: bigint;  // 新的最大 Gas 價格（可選）\n})\n```\n\n#### 響應\n\n```json\n{\n  \"success\": true,\n  \"deploymentId\": \"deploy-123e4567-e89b-12d3-a456-426614174000\",\n  \"message\": \"Deployment retry initiated\",\n  \"newDeploymentId\": \"deploy-retry-123e4567-e89b-12d3-a456-426614174000\"\n}\n```\n\n#### 錯誤碼\n\n| 錯誤碼 | 描述 |\n|--------|------|\n| `DEPLOYMENT_NOT_FOUND` | 部署不存在 |\n| `DEPLOYMENT_NOT_FAILED` | 部署未失敗（無法重試） |\n| `MAX_RETRIES_EXCEEDED` | 已達到最大重試次數 |\n| `RETRY_FAILED` | 重試失敗 |\n\n#### 示例\n\n```typescript\n// 重試失敗的部署\ntry {\n  const result = await trpc.phaseADeployment.retryFailedDeployment.mutate({\n    deploymentId: \"deploy-123e4567-e89b-12d3-a456-426614174000\",\n    maxGasPrice: ethers.parseUnits(\"50\", \"gwei\"),\n  });\n\n  console.log(`Retry initiated: ${result.newDeploymentId}`);\n} catch (error) {\n  console.error(`Retry failed: ${error.message}`);\n}\n```\n\n---\n\n## 部署流程\n\n### 標準部署流程\n\n```\n1. 調用 deployMarket\n   ↓\n2. 參數驗證\n   ↓\n3. Gas 估算\n   ↓\n4. 交易簽署\n   ↓\n5. 交易提交\n   ↓\n6. 等待確認（3 個區塊）\n   ↓\n7. 返回結果\n```\n\n### 失敗重試流程\n\n```\n1. 交易失敗\n   ↓\n2. 等待 1 秒（指數退避）\n   ↓\n3. 重試（最多 3 次）\n   ↓\n4. 如果仍失敗，觸發告警\n   ↓\n5. 返回失敗結果\n```\n\n---\n\n## 性能指標\n\n### 響應時間\n\n| 操作 | P50 | P95 | P99 |\n|------|-----|-----|-----|\n| 部署市場 | 45s | 60s | 90s |\n| 查詢狀態 | 100ms | 200ms | 500ms |\n| 重試部署 | 45s | 60s | 90s |\n\n### 成功率\n\n- 部署成功率: > 99.5%\n- 重試成功率: > 95%\n- 確認成功率: 100%\n\n---\n\n## 最佳實踐\n\n### 1. 參數驗證\n\n始終驗證部署參數：\n\n```typescript\n// ✅ 好：驗證參數\nif (endDate <= new Date()) {\n  throw new Error(\"End date must be in the future\");\n}\n\nif (!ethers.isAddress(oracleAddress)) {\n  throw new Error(\"Invalid Oracle address\");\n}\n\nif (initialLiquidity <= 0n) {\n  throw new Error(\"Initial liquidity must be positive\");\n}\n```\n\n### 2. 錯誤處理\n\n實現完整的錯誤處理：\n\n```typescript\n// ✅ 好：完整的錯誤處理\ntry {\n  const result = await trpc.phaseADeployment.deployMarket.mutate(params);\n  // 處理成功\n} catch (error) {\n  if (error.code === \"VALIDATION_ERROR\") {\n    // 處理驗證錯誤\n  } else if (error.code === \"DEPLOYMENT_FAILED\") {\n    // 處理部署失敗\n  } else {\n    // 處理其他錯誤\n  }\n}\n```\n\n### 3. 重試邏輯\n\n實現客戶端重試邏輯：\n\n```typescript\n// ✅ 好：客戶端重試\nasync function deployWithRetry(params, maxRetries = 3) {\n  for (let i = 0; i < maxRetries; i++) {\n    try {\n      return await trpc.phaseADeployment.deployMarket.mutate(params);\n    } catch (error) {\n      if (i === maxRetries - 1) throw error;\n      await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i)));\n    }\n  }\n}\n```\n\n### 4. 監控部署\n\n定期檢查部署狀態：\n\n```typescript\n// ✅ 好：定期檢查狀態\nasync function monitorDeployment(deploymentId) {\n  const maxAttempts = 60; // 5 分鐘\n  for (let i = 0; i < maxAttempts; i++) {\n    const status = await trpc.phaseADeployment.getDeploymentStatus.query({\n      deploymentId,\n    });\n\n    if (status.status === \"completed\") {\n      return status;\n    } else if (status.status === \"failed\") {\n      throw new Error(`Deployment failed: ${status.errorMessage}`);\n    }\n\n    await new Promise(resolve => setTimeout(resolve, 5000)); // 5 秒\n  }\n\n  throw new Error(\"Deployment timeout\");\n}\n```\n\n---\n\n## 常見問題\n\n### Q: 部署需要多長時間？\n\n**A**: 通常 45-60 秒，包括交易簽署、提交和 3 個區塊確認。高 Gas 價格或網絡擁塞可能導致更長的時間。\n\n### Q: 如何處理部署失敗？\n\n**A**: 使用 `retryFailedDeployment` 端點重試。系統會自動使用新的 Gas 價格重試。\n\n### Q: 部署成本是多少？\n\n**A**: 成本取決於 Gas 價格和合約複雜性。通常 $100-500 之間。使用 `deployMarket` 的響應中的 `totalCostUsd` 字段查看實際成本。\n\n### Q: 如何確保部署成功？\n\n**A**: \n1. 驗證所有參數\n2. 確保賬戶有足夠的 ETH\n3. 使用合理的 Gas 價格\n4. 監控部署狀態\n5. 如果失敗，使用重試功能\n\n---\n\n## 相關文檔\n\n- [告警 API 文檔](./API_ALERTS.md)\n- [數據庫 API 文檔](./API_DATABASE.md)\n- [監控 API 文檔](./API_MONITORING.md)\n- [部署指南](./DEPLOYMENT_GUIDE.md)\n- [故障排查指南](./TROUBLESHOOTING.md)\n
