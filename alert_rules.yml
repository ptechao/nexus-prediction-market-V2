# Prometheus 告警規則\n# 定義系統告警條件\n\ngroups:\n  - name: nexus_deployment_alerts\n    interval: 30s\n    rules:\n      # 部署成功率低於 95%\n      - alert: LowDeploymentSuccessRate\n        expr: nexus_deployment_success_rate < 95\n        for: 5m\n        labels:\n          severity: warning\n          service: deployment\n        annotations:\n          summary: \"Low deployment success rate\"\n          description: \"Deployment success rate is {{ $value }}%, below threshold of 95%\"\n\n      # 部署失敗\n      - alert: DeploymentFailure\n        expr: increase(nexus_deployments_total{status=\"failure\"}[5m]) > 0\n        for: 1m\n        labels:\n          severity: critical\n          service: deployment\n        annotations:\n          summary: \"Deployment failure detected\"\n          description: \"{{ $value }} deployments failed in the last 5 minutes\"\n\n      # 部署耗時過長\n      - alert: SlowDeployment\n        expr: nexus_deployment_duration_seconds > 600\n        for: 2m\n        labels:\n          severity: warning\n          service: deployment\n        annotations:\n          summary: \"Slow deployment detected\"\n          description: \"Deployment took {{ $value }} seconds, exceeding 600s threshold\"\n\n  - name: nexus_gas_alerts\n    interval: 30s\n    rules:\n      # Gas 價格過高\n      - alert: HighGasPrice\n        expr: nexus_gas_price_gwei > 100\n        for: 5m\n        labels:\n          severity: warning\n          service: gas\n        annotations:\n          summary: \"High gas price detected\"\n          description: \"Current gas price is {{ $value }} Gwei, above threshold of 100 Gwei\"\n\n      # Gas 估算錯誤\n      - alert: GasEstimationErrors\n        expr: increase(nexus_gas_estimation_errors_total[5m]) > 5\n        for: 2m\n        labels:\n          severity: warning\n          service: gas\n        annotations:\n          summary: \"High gas estimation error rate\"\n          description: \"{{ $value }} gas estimation errors in the last 5 minutes\"\n\n      # Gas 成本過高\n      - alert: HighGasCost\n        expr: nexus_gas_cost_usd > 100\n        for: 5m\n        labels:\n          severity: warning\n          service: gas\n        annotations:\n          summary: \"High gas cost detected\"\n          description: \"Estimated gas cost is ${{ $value }}, above threshold of $100\"\n\n  - name: nexus_transaction_alerts\n    interval: 30s\n    rules:\n      # 交易確認率低\n      - alert: LowTransactionConfirmationRate\n        expr: nexus_transaction_confirmation_rate < 90\n        for: 5m\n        labels:\n          severity: warning\n          service: transaction\n        annotations:\n          summary: \"Low transaction confirmation rate\"\n          description: \"Transaction confirmation rate is {{ $value }}%, below threshold of 90%\"\n\n      # 交易確認耗時過長\n      - alert: SlowTransactionConfirmation\n        expr: nexus_transaction_confirmation_time_seconds > 300\n        for: 2m\n        labels:\n          severity: warning\n          service: transaction\n        annotations:\n          summary: \"Slow transaction confirmation\"\n          description: \"Transaction confirmation took {{ $value }} seconds, exceeding 300s threshold\"\n\n      # 交易失敗\n      - alert: TransactionFailures\n        expr: increase(nexus_transaction_failures_total[5m]) > 3\n        for: 2m\n        labels:\n          severity: critical\n          service: transaction\n        annotations:\n          summary: \"High transaction failure rate\"\n          description: \"{{ $value }} transactions failed in the last 5 minutes\"\n\n  - name: nexus_alert_alerts\n    interval: 30s\n    rules:\n      # 關鍵告警\n      - alert: CriticalAlertTriggered\n        expr: increase(nexus_alerts_total{level=\"CRITICAL\"}[5m]) > 0\n        for: 1m\n        labels:\n          severity: critical\n          service: alerts\n        annotations:\n          summary: \"Critical alert triggered\"\n          description: \"{{ $value }} critical alerts in the last 5 minutes\"\n\n      # 告警響應時間過長\n      - alert: SlowAlertResponse\n        expr: nexus_alert_response_time_seconds > 60\n        for: 2m\n        labels:\n          severity: warning\n          service: alerts\n        annotations:\n          summary: \"Slow alert response time\"\n          description: \"Alert response time is {{ $value }} seconds, exceeding 60s threshold\"\n\n  - name: nexus_api_alerts\n    interval: 30s\n    rules:\n      # API 錯誤率高\n      - alert: HighApiErrorRate\n        expr: (increase(nexus_api_errors_total[5m]) / increase(nexus_api_requests_in_flight[5m])) > 0.05\n        for: 2m\n        labels:\n          severity: warning\n          service: api\n        annotations:\n          summary: \"High API error rate\"\n          description: \"API error rate is {{ $value | humanizePercentage }}, above threshold of 5%\"\n\n      # API 響應時間過長\n      - alert: SlowApiResponse\n        expr: nexus_api_request_duration_ms > 5000\n        for: 2m\n        labels:\n          severity: warning\n          service: api\n        annotations:\n          summary: \"Slow API response time\"\n          description: \"API response time is {{ $value }}ms, exceeding 5000ms threshold\"\n\n      # API 請求堆積\n      - alert: ApiRequestsBacklog\n        expr: nexus_api_requests_in_flight > 100\n        for: 2m\n        labels:\n          severity: warning\n          service: api\n        annotations:\n          summary: \"API requests backlog detected\"\n          description: \"{{ $value }} API requests in flight, above threshold of 100\"\n\n  - name: nexus_system_alerts\n    interval: 30s\n    rules:\n      # 高 CPU 使用率\n      - alert: HighCpuUsage\n        expr: (1 - avg by (instance) (rate(node_cpu_seconds_total{mode=\"idle\"}[5m]))) > 0.8\n        for: 5m\n        labels:\n          severity: warning\n          service: system\n        annotations:\n          summary: \"High CPU usage detected\"\n          description: \"CPU usage is {{ $value | humanizePercentage }}, above threshold of 80%\"\n\n      # 高內存使用率\n      - alert: HighMemoryUsage\n        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) > 0.85\n        for: 5m\n        labels:\n          severity: warning\n          service: system\n        annotations:\n          summary: \"High memory usage detected\"\n          description: \"Memory usage is {{ $value | humanizePercentage }}, above threshold of 85%\"\n\n      # 磁盤空間不足\n      - alert: LowDiskSpace\n        expr: (node_filesystem_avail_bytes / node_filesystem_size_bytes) < 0.1\n        for: 5m\n        labels:\n          severity: critical\n          service: system\n        annotations:\n          summary: \"Low disk space detected\"\n          description: \"Disk usage is {{ $value | humanizePercentage }}, below threshold of 10% free\"\n
