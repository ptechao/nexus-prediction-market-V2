/**\n * 部署流程集成測試\n * \n * 測試完整的部署流程，包括參數驗證、Gas 估算、交易簽署、提交和確認。\n */\n\nimport { describe, it, expect, beforeAll, afterAll, vi } from 'vitest';\nimport blockchainDeployment from '../../services/blockchainDeployment';\nimport deploymentValidator from '../../services/deploymentValidator';\nimport deploymentLogger from '../../services/deploymentLogger';\nimport gasManager from '../../services/gasManager';\nimport { ethers } from 'ethers';\n\n/**\n * 測試配置\n */\nconst TEST_CONFIG = {\n  rpcUrl: process.env.SEPOLIA_RPC_URL || 'https://sepolia.infura.io/v3/test',\n  deployerPrivateKey: process.env.DEPLOYER_PRIVATE_KEY || '0x' + '1'.repeat(64),\n  oracleAddress: '0x' + 'a'.repeat(40),\n  initialLiquidity: ethers.parseEther('1'),\n};\n\n/**\n * Mock 提供商\n */\nlet mockProvider: any;\nlet mockSigner: any;\n\ndescribe('部署流程集成測試', () => {\n  beforeAll(() => {\n    // 初始化 Mock 提供商\n    mockProvider = {\n      getNetwork: vi.fn().mockResolvedValue({ chainId: 11155111, name: 'sepolia' }),\n      getGasPrice: vi.fn().mockResolvedValue(ethers.parseUnits('20', 'gwei')),\n      getBalance: vi.fn().mockResolvedValue(ethers.parseEther('10')),\n      estimateGas: vi.fn().mockResolvedValue(100000n),\n      getTransactionCount: vi.fn().mockResolvedValue(0),\n      waitForTransaction: vi.fn().mockResolvedValue({\n        blockNumber: 100,\n        transactionHash: '0x' + 'b'.repeat(64),\n        status: 1,\n      }),\n    };\n\n    mockSigner = {\n      getAddress: vi.fn().mockResolvedValue('0x' + 'c'.repeat(40)),\n      signTransaction: vi.fn().mockResolvedValue('0x' + 'd'.repeat(130)),\n      sendTransaction: vi.fn().mockResolvedValue({\n        hash: '0x' + 'e'.repeat(64),\n        wait: vi.fn().mockResolvedValue({\n          blockNumber: 100,\n          transactionHash: '0x' + 'e'.repeat(64),\n          status: 1,\n        }),\n      }),\n    };\n  });\n\n  afterAll(() => {\n    vi.clearAllMocks();\n  });\n\n  describe('完整部署流程', () => {\n    it('應該成功完成 BinaryMarket 部署流程', async () => {\n      const deploymentId = 'test-deploy-' + Date.now();\n      const marketParams = {\n        title: 'Test Market',\n        description: 'Test Description',\n        endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),\n        oracleAddress: TEST_CONFIG.oracleAddress,\n        initialLiquidity: TEST_CONFIG.initialLiquidity,\n      };\n\n      // 步驟 1：參數驗證\n      const validation = await deploymentValidator.validateDeploymentParams(marketParams);\n      expect(validation.valid).toBe(true);\n      expect(validation.errors).toHaveLength(0);\n\n      // 步驟 2：Gas 估算\n      const gasEstimate = await gasManager.estimateGas('BinaryMarket', marketParams);\n      expect(gasEstimate.estimatedGas).toBeGreaterThan(0);\n      expect(gasEstimate.estimatedCostUsd).toBeGreaterThan(0);\n\n      // 步驟 3：Gas 預算檢查\n      const budgetCheck = await gasManager.checkGasBudget(\n        gasEstimate.estimatedCostUsd,\n        1000 // $1000 預算\n      );\n      expect(budgetCheck.withinBudget).toBe(true);\n\n      // 步驟 4：部署\n      const deploymentResult = await blockchainDeployment.deployBinaryMarketContract(\n        marketParams,\n        mockSigner,\n        mockProvider\n      );\n\n      expect(deploymentResult.success).toBe(true);\n      expect(deploymentResult.contractAddress).toBeDefined();\n      expect(deploymentResult.transactionHash).toBeDefined();\n      expect(deploymentResult.blockNumber).toBeGreaterThan(0);\n      expect(deploymentResult.gasUsed).toBeGreaterThan(0);\n\n      // 步驟 5：日誌記錄\n      await deploymentLogger.logDeployment({\n        deploymentId,\n        type: 'BinaryMarket',\n        status: 'completed',\n        contractAddress: deploymentResult.contractAddress,\n        transactionHash: deploymentResult.transactionHash,\n        blockNumber: deploymentResult.blockNumber,\n        gasUsed: deploymentResult.gasUsed,\n        gasPriceFinal: deploymentResult.gasPriceFinal,\n        totalCostUsd: deploymentResult.totalCostUsd,\n        deploymentDuration: deploymentResult.deploymentDuration,\n        confirmations: 3,\n      });\n\n      // 驗證日誌\n      const logs = await deploymentLogger.getDeploymentLogs({\n        limit: 1,\n      });\n      expect(logs.length).toBeGreaterThan(0);\n    });\n\n    it('應該成功完成 CopyTradingVault 部署流程', async () => {\n      const vaultParams = {\n        name: 'Test Vault',\n        symbol: 'TV',\n        manager: '0x' + 'f'.repeat(40),\n        performanceFee: 20, // 2%\n        managementFee: 10, // 1%\n      };\n\n      // 參數驗證\n      const validation = await deploymentValidator.validateDeploymentParams(vaultParams);\n      expect(validation.valid).toBe(true);\n\n      // Gas 估算\n      const gasEstimate = await gasManager.estimateGas('CopyTradingVault', vaultParams);\n      expect(gasEstimate.estimatedGas).toBeGreaterThan(0);\n\n      // 部署\n      const deploymentResult = await blockchainDeployment.deployCopyTradingVaultContract(\n        vaultParams,\n        mockSigner,\n        mockProvider\n      );\n\n      expect(deploymentResult.success).toBe(true);\n      expect(deploymentResult.contractAddress).toBeDefined();\n    });\n  });\n\n  describe('失敗重試流程', () => {\n    it('應該在交易失敗時自動重試', async () => {\n      const marketParams = {\n        title: 'Test Market',\n        description: 'Test Description',\n        endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),\n        oracleAddress: TEST_CONFIG.oracleAddress,\n        initialLiquidity: TEST_CONFIG.initialLiquidity,\n      };\n\n      // Mock 第一次失敗，第二次成功\n      let callCount = 0;\n      mockSigner.sendTransaction = vi.fn().mockImplementation(async () => {\n        callCount++;\n        if (callCount === 1) {\n          throw new Error('Transaction failed');\n        }\n        return {\n          hash: '0x' + 'e'.repeat(64),\n          wait: vi.fn().mockResolvedValue({\n            blockNumber: 100,\n            transactionHash: '0x' + 'e'.repeat(64),\n            status: 1,\n          }),\n        };\n      });\n\n      // 部署（應該自動重試）\n      const deploymentResult = await blockchainDeployment.deployBinaryMarketContract(\n        marketParams,\n        mockSigner,\n        mockProvider\n      );\n\n      expect(deploymentResult.success).toBe(true);\n      expect(callCount).toBe(2); // 應該被調用 2 次\n    });\n\n    it('應該在多次失敗後放棄', async () => {\n      const marketParams = {\n        title: 'Test Market',\n        description: 'Test Description',\n        endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),\n        oracleAddress: TEST_CONFIG.oracleAddress,\n        initialLiquidity: TEST_CONFIG.initialLiquidity,\n      };\n\n      // Mock 所有嘗試都失敗\n      mockSigner.sendTransaction = vi.fn().mockRejectedValue(\n        new Error('Transaction failed')\n      );\n\n      // 部署（應該在 3 次重試後失敗）\n      const deploymentResult = await blockchainDeployment.deployBinaryMarketContract(\n        marketParams,\n        mockSigner,\n        mockProvider\n      );\n\n      expect(deploymentResult.success).toBe(false);\n      expect(deploymentResult.error).toBeDefined();\n    });\n  });\n\n  describe('超時處理', () => {\n    it('應該在超時時拋出錯誤', async () => {\n      const marketParams = {\n        title: 'Test Market',\n        description: 'Test Description',\n        endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),\n        oracleAddress: TEST_CONFIG.oracleAddress,\n        initialLiquidity: TEST_CONFIG.initialLiquidity,\n      };\n\n      // Mock 超時\n      mockProvider.waitForTransaction = vi.fn().mockImplementation(\n        () => new Promise((resolve) => {\n          setTimeout(() => {\n            throw new Error('Transaction timeout');\n          }, 100);\n        })\n      );\n\n      // 部署（應該超時）\n      const deploymentResult = await blockchainDeployment.deployBinaryMarketContract(\n        marketParams,\n        mockSigner,\n        mockProvider\n      );\n\n      expect(deploymentResult.success).toBe(false);\n    });\n  });\n\n  describe('並發部署', () => {\n    it('應該能夠處理並發部署', async () => {\n      const deployments = Array.from({ length: 5 }, (_, i) => ({\n        title: `Test Market ${i}`,\n        description: `Test Description ${i}`,\n        endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),\n        oracleAddress: TEST_CONFIG.oracleAddress,\n        initialLiquidity: TEST_CONFIG.initialLiquidity,\n      }));\n\n      // 並發部署\n      const results = await Promise.all(\n        deployments.map((params) =>\n          blockchainDeployment.deployBinaryMarketContract(\n            params,\n            mockSigner,\n            mockProvider\n          )\n        )\n      );\n\n      // 驗證所有部署都成功\n      expect(results.every((r) => r.success)).toBe(true);\n      expect(results).toHaveLength(5);\n    });\n  });\n\n  describe('告警系統集成', () => {\n    it('應該在部署失敗時觸發告警', async () => {\n      const deploymentId = 'test-deploy-' + Date.now();\n      const marketParams = {\n        title: 'Test Market',\n        description: 'Test Description',\n        endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),\n        oracleAddress: TEST_CONFIG.oracleAddress,\n        initialLiquidity: TEST_CONFIG.initialLiquidity,\n      };\n\n      // Mock 部署失敗\n      mockSigner.sendTransaction = vi.fn().mockRejectedValue(\n        new Error('Transaction failed')\n      );\n\n      // 部署\n      const deploymentResult = await blockchainDeployment.deployBinaryMarketContract(\n        marketParams,\n        mockSigner,\n        mockProvider\n      );\n\n      // 如果部署失敗，應該觸發告警\n      if (!deploymentResult.success) {\n        await deploymentLogger.logAlert({\n          title: 'Deployment Failed',\n          description: `Deployment ${deploymentId} failed: ${deploymentResult.error}`,\n          level: 'CRITICAL',\n          source: 'deployment',\n          sourceId: deploymentId,\n          category: 'deployment',\n        });\n\n        // 驗證告警\n        const alerts = await deploymentLogger.getActiveAlerts({\n          level: 'CRITICAL',\n        });\n        expect(alerts.length).toBeGreaterThan(0);\n      }\n    });\n\n    it('應該在 Gas 價格過高時觸發告警', async () => {\n      // Mock 高 Gas 價格\n      mockProvider.getGasPrice = vi\n        .fn()\n        .mockResolvedValue(ethers.parseUnits('500', 'gwei'));\n\n      // 檢查 Gas 價格\n      const gasPrice = await mockProvider.getGasPrice();\n      const gasPriceGwei = Number(ethers.formatUnits(gasPrice, 'gwei'));\n\n      if (gasPriceGwei > 100) {\n        // 觸發告警\n        await deploymentLogger.logAlert({\n          title: 'High Gas Price',\n          description: `Gas price is ${gasPriceGwei} Gwei, exceeding threshold of 100 Gwei`,\n          level: 'WARNING',\n          source: 'gas-monitor',\n          category: 'gas',\n        });\n\n        // 驗證告警\n        const alerts = await deploymentLogger.getActiveAlerts({\n          level: 'WARNING',\n        });\n        expect(alerts.length).toBeGreaterThan(0);\n      }\n    });\n  });\n\n  describe('數據持久化集成', () => {\n    it('應該正確記錄部署日誌', async () => {\n      const deploymentId = 'test-deploy-' + Date.now();\n\n      // 記錄部署日誌\n      await deploymentLogger.logDeployment({\n        deploymentId,\n        type: 'BinaryMarket',\n        status: 'completed',\n        contractAddress: '0x' + 'a'.repeat(40),\n        transactionHash: '0x' + 'b'.repeat(64),\n        blockNumber: 100,\n        gasUsed: 100000,\n        gasPriceFinal: 20000000000,\n        totalCostWei: 2000000000000000n,\n        totalCostUsd: 5.5,\n        deploymentDuration: 45,\n        confirmations: 3,\n      });\n\n      // 查詢部署日誌\n      const logs = await deploymentLogger.getDeploymentLogs({\n        type: 'BinaryMarket',\n        limit: 10,\n      });\n\n      expect(logs.length).toBeGreaterThan(0);\n      expect(logs[0].deploymentId).toBe(deploymentId);\n    });\n\n    it('應該正確記錄審計日誌', async () => {\n      // 記錄審計日誌\n      await deploymentLogger.logAudit({\n        userId: 'test-user',\n        action: 'DEPLOY_MARKET',\n        resource: 'market',\n        resourceId: 'market-123',\n        status: 'success',\n        statusCode: 200,\n        method: 'POST',\n        endpoint: '/api/trpc/deployMarket',\n        duration: 45000,\n      });\n\n      // 查詢審計日誌\n      const logs = await deploymentLogger.getAuditLogs({\n        action: 'DEPLOY_MARKET',\n        limit: 10,\n      });\n\n      expect(logs.length).toBeGreaterThan(0);\n    });\n  });\n});\n
