/**\n * 部署性能測試\n * \n * 測試部署流程的性能指標，包括部署時間、Gas 估算時間等。\n */\n\nimport { describe, it, expect, beforeAll, afterAll, vi } from 'vitest';\nimport blockchainDeployment from '../../services/blockchainDeployment';\nimport gasManager from '../../services/gasManager';\nimport { ethers } from 'ethers';\n\n/**\n * 性能測試配置\n */\nconst PERFORMANCE_TARGETS = {\n  deploymentTime: 60000, // 60 秒\n  gasEstimationTime: 5000, // 5 秒\n  confirmationTime: 30000, // 30 秒\n  queryTime: 100, // 100 毫秒\n  apiResponseTime: 500, // 500 毫秒\n};\n\n/**\n * 性能測試工具\n */\nclass PerformanceMonitor {\n  private startTime: number = 0;\n  private measurements: Record<string, number[]> = {};\n\n  start(): void {\n    this.startTime = Date.now();\n  }\n\n  end(label: string): number {\n    const duration = Date.now() - this.startTime;\n    if (!this.measurements[label]) {\n      this.measurements[label] = [];\n    }\n    this.measurements[label].push(duration);\n    return duration;\n  }\n\n  getStats(label: string) {\n    const values = this.measurements[label] || [];\n    if (values.length === 0) return null;\n\n    const sorted = [...values].sort((a, b) => a - b);\n    const sum = sorted.reduce((a, b) => a + b, 0);\n    const avg = sum / sorted.length;\n    const p50 = sorted[Math.floor(sorted.length * 0.5)];\n    const p95 = sorted[Math.floor(sorted.length * 0.95)];\n    const p99 = sorted[Math.floor(sorted.length * 0.99)];\n    const min = sorted[0];\n    const max = sorted[sorted.length - 1];\n\n    return { avg, p50, p95, p99, min, max, count: sorted.length };\n  }\n\n  printStats(): void {\n    console.log('\\n=== 性能測試結果 ===\\n');\n    for (const [label, values] of Object.entries(this.measurements)) {\n      const stats = this.getStats(label);\n      if (stats) {\n        console.log(`${label}:`);\n        console.log(`  平均: ${stats.avg.toFixed(2)}ms`);\n        console.log(`  P50: ${stats.p50}ms`);\n        console.log(`  P95: ${stats.p95}ms`);\n        console.log(`  P99: ${stats.p99}ms`);\n        console.log(`  最小: ${stats.min}ms`);\n        console.log(`  最大: ${stats.max}ms`);\n        console.log(`  樣本數: ${stats.count}\\n`);\n      }\n    }\n  }\n}\n\nlet monitor: PerformanceMonitor;\nlet mockProvider: any;\nlet mockSigner: any;\n\ndescribe('部署性能測試', () => {\n  beforeAll(() => {\n    monitor = new PerformanceMonitor();\n\n    // 初始化 Mock 提供商\n    mockProvider = {\n      getNetwork: vi.fn().mockResolvedValue({ chainId: 11155111, name: 'sepolia' }),\n      getGasPrice: vi.fn().mockResolvedValue(ethers.parseUnits('20', 'gwei')),\n      getBalance: vi.fn().mockResolvedValue(ethers.parseEther('10')),\n      estimateGas: vi.fn().mockResolvedValue(100000n),\n      getTransactionCount: vi.fn().mockResolvedValue(0),\n      waitForTransaction: vi.fn().mockResolvedValue({\n        blockNumber: 100,\n        transactionHash: '0x' + 'b'.repeat(64),\n        status: 1,\n      }),\n    };\n\n    mockSigner = {\n      getAddress: vi.fn().mockResolvedValue('0x' + 'c'.repeat(40)),\n      signTransaction: vi.fn().mockResolvedValue('0x' + 'd'.repeat(130)),\n      sendTransaction: vi.fn().mockResolvedValue({\n        hash: '0x' + 'e'.repeat(64),\n        wait: vi.fn().mockResolvedValue({\n          blockNumber: 100,\n          transactionHash: '0x' + 'e'.repeat(64),\n          status: 1,\n        }),\n      }),\n    };\n  });\n\n  afterAll(() => {\n    monitor.printStats();\n  });\n\n  describe('部署時間性能', () => {\n    it('應該在 60 秒內完成部署', async () => {\n      const marketParams = {\n        title: 'Test Market',\n        description: 'Test Description',\n        endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),\n        oracleAddress: '0x' + 'a'.repeat(40),\n        initialLiquidity: ethers.parseEther('1'),\n      };\n\n      monitor.start();\n      const result = await blockchainDeployment.deployBinaryMarketContract(\n        marketParams,\n        mockSigner,\n        mockProvider\n      );\n      const duration = monitor.end('deployment');\n\n      expect(result.success).toBe(true);\n      expect(duration).toBeLessThan(PERFORMANCE_TARGETS.deploymentTime);\n    });\n\n    it('應該在 60 秒內完成 10 次連續部署', async () => {\n      const marketParams = {\n        title: 'Test Market',\n        description: 'Test Description',\n        endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),\n        oracleAddress: '0x' + 'a'.repeat(40),\n        initialLiquidity: ethers.parseEther('1'),\n      };\n\n      monitor.start();\n      for (let i = 0; i < 10; i++) {\n        const result = await blockchainDeployment.deployBinaryMarketContract(\n          marketParams,\n          mockSigner,\n          mockProvider\n        );\n        expect(result.success).toBe(true);\n      }\n      const duration = monitor.end('10_deployments');\n\n      // 平均每次部署應該在 6 秒以內\n      expect(duration / 10).toBeLessThan(6000);\n    });\n  });\n\n  describe('Gas 估算性能', () => {\n    it('應該在 5 秒內完成 Gas 估算', async () => {\n      const marketParams = {\n        title: 'Test Market',\n        description: 'Test Description',\n        endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),\n        oracleAddress: '0x' + 'a'.repeat(40),\n        initialLiquidity: ethers.parseEther('1'),\n      };\n\n      monitor.start();\n      const estimate = await gasManager.estimateGas('BinaryMarket', marketParams);\n      const duration = monitor.end('gas_estimation');\n\n      expect(estimate.estimatedGas).toBeGreaterThan(0);\n      expect(duration).toBeLessThan(PERFORMANCE_TARGETS.gasEstimationTime);\n    });\n\n    it('應該在 100 毫秒內從緩存返回 Gas 估算', async () => {\n      const marketParams = {\n        title: 'Test Market',\n        description: 'Test Description',\n        endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),\n        oracleAddress: '0x' + 'a'.repeat(40),\n        initialLiquidity: ethers.parseEther('1'),\n      };\n\n      // 第一次調用（不在緩存中）\n      await gasManager.estimateGas('BinaryMarket', marketParams);\n\n      // 第二次調用（應該在緩存中）\n      monitor.start();\n      const estimate = await gasManager.estimateGas('BinaryMarket', marketParams);\n      const duration = monitor.end('gas_estimation_cached');\n\n      expect(estimate.estimatedGas).toBeGreaterThan(0);\n      expect(duration).toBeLessThan(100);\n    });\n  });\n\n  describe('交易確認性能', () => {\n    it('應該在 30 秒內完成交易確認', async () => {\n      // Mock 交易確認\n      mockProvider.waitForTransaction = vi.fn().mockImplementation(async () => {\n        await new Promise((resolve) => setTimeout(resolve, 15000)); // 模擬 15 秒\n        return {\n          blockNumber: 100,\n          transactionHash: '0x' + 'e'.repeat(64),\n          status: 1,\n        };\n      });\n\n      monitor.start();\n      const result = await blockchainDeployment.waitForConfirmation(\n        '0x' + 'e'.repeat(64),\n        mockProvider,\n        3\n      );\n      const duration = monitor.end('confirmation');\n\n      expect(result.success).toBe(true);\n      expect(duration).toBeLessThan(PERFORMANCE_TARGETS.confirmationTime);\n    });\n  });\n\n  describe('查詢性能', () => {\n    it('應該在 100 毫秒內完成查詢', async () => {\n      // Mock 數據庫查詢\n      const mockQuery = vi.fn().mockResolvedValue([\n        {\n          id: '1',\n          deploymentId: 'deploy-1',\n          type: 'BinaryMarket',\n          status: 'completed',\n        },\n      ]);\n\n      monitor.start();\n      await mockQuery();\n      const duration = monitor.end('query');\n\n      expect(duration).toBeLessThan(PERFORMANCE_TARGETS.queryTime);\n    });\n\n    it('應該在 500 毫秒內完成 API 響應', async () => {\n      const marketParams = {\n        title: 'Test Market',\n        description: 'Test Description',\n        endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),\n        oracleAddress: '0x' + 'a'.repeat(40),\n        initialLiquidity: ethers.parseEther('1'),\n      };\n\n      monitor.start();\n      const result = await blockchainDeployment.deployBinaryMarketContract(\n        marketParams,\n        mockSigner,\n        mockProvider\n      );\n      const duration = monitor.end('api_response');\n\n      expect(result.success).toBe(true);\n      expect(duration).toBeLessThan(PERFORMANCE_TARGETS.apiResponseTime);\n    });\n  });\n\n  describe('並發性能', () => {\n    it('應該能夠處理 10 個並發部署', async () => {\n      const marketParams = {\n        title: 'Test Market',\n        description: 'Test Description',\n        endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),\n        oracleAddress: '0x' + 'a'.repeat(40),\n        initialLiquidity: ethers.parseEther('1'),\n      };\n\n      monitor.start();\n      const promises = Array.from({ length: 10 }, () =>\n        blockchainDeployment.deployBinaryMarketContract(\n          marketParams,\n          mockSigner,\n          mockProvider\n        )\n      );\n      const results = await Promise.all(promises);\n      const duration = monitor.end('concurrent_10_deployments');\n\n      expect(results.every((r) => r.success)).toBe(true);\n      // 並發應該比順序快得多\n      expect(duration).toBeLessThan(PERFORMANCE_TARGETS.deploymentTime * 2);\n    });\n\n    it('應該能夠處理 50 個並發部署', async () => {\n      const marketParams = {\n        title: 'Test Market',\n        description: 'Test Description',\n        endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),\n        oracleAddress: '0x' + 'a'.repeat(40),\n        initialLiquidity: ethers.parseEther('1'),\n      };\n\n      monitor.start();\n      const promises = Array.from({ length: 50 }, () =>\n        blockchainDeployment.deployBinaryMarketContract(\n          marketParams,\n          mockSigner,\n          mockProvider\n        )\n      );\n      const results = await Promise.all(promises);\n      const duration = monitor.end('concurrent_50_deployments');\n\n      expect(results.every((r) => r.success)).toBe(true);\n      console.log(`50 個並發部署耗時: ${duration}ms`);\n    });\n  });\n\n  describe('內存性能', () => {\n    it('應該在部署過程中保持內存使用在合理範圍內', async () => {\n      const marketParams = {\n        title: 'Test Market',\n        description: 'Test Description',\n        endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),\n        oracleAddress: '0x' + 'a'.repeat(40),\n        initialLiquidity: ethers.parseEther('1'),\n      };\n\n      const initialMemory = process.memoryUsage().heapUsed;\n\n      // 執行 100 次部署\n      for (let i = 0; i < 100; i++) {\n        await blockchainDeployment.deployBinaryMarketContract(\n          marketParams,\n          mockSigner,\n          mockProvider\n        );\n      }\n\n      const finalMemory = process.memoryUsage().heapUsed;\n      const memoryIncrease = (finalMemory - initialMemory) / 1024 / 1024; // MB\n\n      console.log(`內存增長: ${memoryIncrease.toFixed(2)}MB`);\n      // 內存增長應該在 100MB 以內\n      expect(memoryIncrease).toBeLessThan(100);\n    });\n  });\n});\n
