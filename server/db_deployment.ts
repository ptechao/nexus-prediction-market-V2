/**\n * 部署相關的數據庫查詢助手\n * \n * 提供部署日誌、告警和審計日誌的查詢和插入函數。\n */\n\nimport { db } from './db';\nimport {\n  deploymentLogs,\n  alerts,\n  auditLogs,\n  deploymentStats,\n  alertStats,\n} from '../drizzle/schema_deployment';\nimport { eq, and, gte, lte, desc, sql } from 'drizzle-orm';\n\n/**\n * 部署日誌查詢助手\n */\nexport const deploymentLogsDb = {\n  /**\n   * 創建部署日誌\n   */\n  async create(data: typeof deploymentLogs.$inferInsert) {\n    const result = await db.insert(deploymentLogs).values(data);\n    return result;\n  },\n\n  /**\n   * 獲取部署日誌\n   */\n  async getById(id: string) {\n    const result = await db\n      .select()\n      .from(deploymentLogs)\n      .where(eq(deploymentLogs.id, id))\n      .limit(1);\n    return result[0];\n  },\n\n  /**\n   * 獲取部署日誌列表\n   */\n  async getList(options?: {\n    type?: string;\n    status?: string;\n    limit?: number;\n    offset?: number;\n  }) {\n    let query = db.select().from(deploymentLogs);\n\n    if (options?.type) {\n      query = query.where(eq(deploymentLogs.type, options.type as any));\n    }\n\n    if (options?.status) {\n      query = query.where(eq(deploymentLogs.status, options.status as any));\n    }\n\n    query = query.orderBy(desc(deploymentLogs.createdAt));\n\n    if (options?.limit) {\n      query = query.limit(options.limit);\n    }\n\n    if (options?.offset) {\n      query = query.offset(options.offset);\n    }\n\n    return await query;\n  },\n\n  /**\n   * 更新部署日誌\n   */\n  async update(id: string, data: Partial<typeof deploymentLogs.$inferInsert>) {\n    const result = await db\n      .update(deploymentLogs)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(deploymentLogs.id, id));\n    return result;\n  },\n\n  /**\n   * 獲取部署統計\n   */\n  async getStats(options?: { type?: string; days?: number }) {\n    const daysAgo = new Date(Date.now() - (options?.days || 7) * 24 * 60 * 60 * 1000);\n\n    let query = db\n      .select({\n        type: deploymentLogs.type,\n        status: deploymentLogs.status,\n        count: sql<number>`COUNT(*) as count`,\n        avgDuration: sql<number>`AVG(deployment_duration) as avg_duration`,\n        avgCost: sql<number>`AVG(total_cost_usd) as avg_cost`,\n      })\n      .from(deploymentLogs)\n      .where(gte(deploymentLogs.createdAt, daysAgo))\n      .groupBy(deploymentLogs.type, deploymentLogs.status);\n\n    if (options?.type) {\n      query = query.where(eq(deploymentLogs.type, options.type as any));\n    }\n\n    return await query;\n  },\n};\n\n/**\n * 告警查詢助手\n */\nexport const alertsDb = {\n  /**\n   * 創建告警\n   */\n  async create(data: typeof alerts.$inferInsert) {\n    const result = await db.insert(alerts).values(data);\n    return result;\n  },\n\n  /**\n   * 獲取告警\n   */\n  async getById(id: string) {\n    const result = await db\n      .select()\n      .from(alerts)\n      .where(eq(alerts.id, id))\n      .limit(1);\n    return result[0];\n  },\n\n  /**\n   * 獲取告警列表\n   */\n  async getList(options?: {\n    level?: string;\n    status?: string;\n    source?: string;\n    limit?: number;\n    offset?: number;\n  }) {\n    let query = db.select().from(alerts);\n\n    const conditions = [];\n\n    if (options?.level) {\n      conditions.push(eq(alerts.level, options.level as any));\n    }\n\n    if (options?.status) {\n      conditions.push(eq(alerts.status, options.status as any));\n    }\n\n    if (options?.source) {\n      conditions.push(eq(alerts.source, options.source));\n    }\n\n    if (conditions.length > 0) {\n      query = query.where(and(...conditions));\n    }\n\n    query = query.orderBy(desc(alerts.createdAt));\n\n    if (options?.limit) {\n      query = query.limit(options.limit);\n    }\n\n    if (options?.offset) {\n      query = query.offset(options.offset);\n    }\n\n    return await query;\n  },\n\n  /**\n   * 確認告警\n   */\n  async acknowledge(id: string, userId: string) {\n    const result = await db\n      .update(alerts)\n      .set({\n        status: 'ACKNOWLEDGED',\n        acknowledgedBy: userId,\n        acknowledgedAt: new Date(),\n        updatedAt: new Date(),\n      })\n      .where(eq(alerts.id, id));\n    return result;\n  },\n\n  /**\n   * 解決告警\n   */\n  async resolve(id: string, userId: string) {\n    const result = await db\n      .update(alerts)\n      .set({\n        status: 'RESOLVED',\n        resolvedBy: userId,\n        resolvedAt: new Date(),\n        updatedAt: new Date(),\n      })\n      .where(eq(alerts.id, id));\n    return result;\n  },\n\n  /**\n   * 獲取活躍告警\n   */\n  async getActive(options?: { level?: string; limit?: number }) {\n    let query = db\n      .select()\n      .from(alerts)\n      .where(eq(alerts.status, 'ACTIVE'));\n\n    if (options?.level) {\n      query = query.where(eq(alerts.level, options.level as any));\n    }\n\n    query = query.orderBy(desc(alerts.priority), desc(alerts.createdAt));\n\n    if (options?.limit) {\n      query = query.limit(options.limit);\n    }\n\n    return await query;\n  },\n};\n\n/**\n * 審計日誌查詢助手\n */\nexport const auditLogsDb = {\n  /**\n   * 創建審計日誌\n   */\n  async create(data: typeof auditLogs.$inferInsert) {\n    const result = await db.insert(auditLogs).values(data);\n    return result;\n  },\n\n  /**\n   * 獲取審計日誌列表\n   */\n  async getList(options?: {\n    userId?: string;\n    action?: string;\n    resource?: string;\n    status?: string;\n    limit?: number;\n    offset?: number;\n  }) {\n    let query = db.select().from(auditLogs);\n\n    const conditions = [];\n\n    if (options?.userId) {\n      conditions.push(eq(auditLogs.userId, options.userId));\n    }\n\n    if (options?.action) {\n      conditions.push(eq(auditLogs.action, options.action));\n    }\n\n    if (options?.resource) {\n      conditions.push(eq(auditLogs.resource, options.resource));\n    }\n\n    if (options?.status) {\n      conditions.push(eq(auditLogs.status, options.status as any));\n    }\n\n    if (conditions.length > 0) {\n      query = query.where(and(...conditions));\n    }\n\n    query = query.orderBy(desc(auditLogs.createdAt));\n\n    if (options?.limit) {\n      query = query.limit(options.limit);\n    }\n\n    if (options?.offset) {\n      query = query.offset(options.offset);\n    }\n\n    return await query;\n  },\n\n  /**\n   * 獲取資源的審計日誌\n   */\n  async getByResource(resource: string, resourceId: string) {\n    const result = await db\n      .select()\n      .from(auditLogs)\n      .where(\n        and(\n          eq(auditLogs.resource, resource),\n          eq(auditLogs.resourceId, resourceId)\n        )\n      )\n      .orderBy(desc(auditLogs.createdAt));\n    return result;\n  },\n};\n\n/**\n * 部署統計查詢助手\n */\nexport const deploymentStatsDb = {\n  /**\n   * 創建或更新部署統計\n   */\n  async upsert(data: typeof deploymentStats.$inferInsert) {\n    // 這裡應該使用 ON DUPLICATE KEY UPDATE\n    // 但 Drizzle ORM 可能不支持，所以使用先刪除再插入\n    const existing = await db\n      .select()\n      .from(deploymentStats)\n      .where(\n        and(\n          eq(deploymentStats.date, data.date!),\n          eq(deploymentStats.type, data.type!)\n        )\n      )\n      .limit(1);\n\n    if (existing.length > 0) {\n      return await db\n        .update(deploymentStats)\n        .set(data)\n        .where(eq(deploymentStats.id, existing[0].id));\n    } else {\n      return await db.insert(deploymentStats).values(data);\n    }\n  },\n\n  /**\n   * 獲取部署統計\n   */\n  async getByDate(date: Date, type?: string) {\n    let query = db\n      .select()\n      .from(deploymentStats)\n      .where(eq(deploymentStats.date, date));\n\n    if (type) {\n      query = query.where(eq(deploymentStats.type, type as any));\n    }\n\n    return await query;\n  },\n};\n\n/**\n * 告警統計查詢助手\n */\nexport const alertStatsDb = {\n  /**\n   * 創建或更新告警統計\n   */\n  async upsert(data: typeof alertStats.$inferInsert) {\n    const existing = await db\n      .select()\n      .from(alertStats)\n      .where(\n        and(\n          eq(alertStats.date, data.date!),\n          eq(alertStats.level, data.level!),\n          eq(alertStats.source, data.source!)\n        )\n      )\n      .limit(1);\n\n    if (existing.length > 0) {\n      return await db\n        .update(alertStats)\n        .set(data)\n        .where(eq(alertStats.id, existing[0].id));\n    } else {\n      return await db.insert(alertStats).values(data);\n    }\n  },\n\n  /**\n   * 獲取告警統計\n   */\n  async getByDate(date: Date, level?: string, source?: string) {\n    let query = db\n      .select()\n      .from(alertStats)\n      .where(eq(alertStats.date, date));\n\n    if (level) {\n      query = query.where(eq(alertStats.level, level as any));\n    }\n\n    if (source) {\n      query = query.where(eq(alertStats.source, source));\n    }\n\n    return await query;\n  },\n};\n
