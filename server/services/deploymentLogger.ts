/**\n * 部署日誌服務\n * \n * 集成部署、告警和審計日誌到數據庫。\n */\n\nimport { deploymentLogsDb, alertsDb, auditLogsDb } from '../db_deployment';\nimport metricsCollector from './metricsCollector';\n\n/**\n * 部署日誌事件\n */\nexport interface DeploymentLogEvent {\n  deploymentId: string;\n  type: 'BinaryMarket' | 'CopyTradingVault';\n  status: 'pending' | 'processing' | 'completed' | 'failed';\n  contractAddress?: string;\n  transactionHash?: string;\n  blockNumber?: number;\n  gasUsed?: number;\n  gasPriceFinal?: number;\n  totalCostWei?: number;\n  totalCostUsd?: number;\n  deploymentDuration?: number;\n  confirmationTime?: number;\n  confirmations?: number;\n  errorMessage?: string;\n  retryCount?: number;\n  parameters?: Record<string, any>;\n  metadata?: Record<string, any>;\n}\n\n/**\n * 告警事件\n */\nexport interface AlertEvent {\n  title: string;\n  description: string;\n  level: 'INFO' | 'WARNING' | 'CRITICAL';\n  source: string;\n  sourceId?: string;\n  category: string;\n  tags?: string[];\n  priority?: number;\n  metadata?: Record<string, any>;\n}\n\n/**\n * 審計日誌事件\n */\nexport interface AuditLogEvent {\n  userId?: string;\n  action: string;\n  resource: string;\n  resourceId: string;\n  status: 'success' | 'failure';\n  statusCode?: number;\n  method?: string;\n  endpoint?: string;\n  ipAddress?: string;\n  userAgent?: string;\n  requestData?: Record<string, any>;\n  responseData?: Record<string, any>;\n  errorMessage?: string;\n  duration?: number;\n  metadata?: Record<string, any>;\n}\n\n/**\n * 部署日誌服務\n */\nexport class DeploymentLogger {\n  /**\n   * 記錄部署日誌\n   */\n  async logDeployment(event: DeploymentLogEvent): Promise<void> {\n    try {\n      await deploymentLogsDb.create({\n        deploymentId: event.deploymentId,\n        type: event.type,\n        status: event.status,\n        contractAddress: event.contractAddress,\n        transactionHash: event.transactionHash,\n        blockNumber: event.blockNumber,\n        gasUsed: event.gasUsed?.toString(),\n        gasPriceFinal: event.gasPriceFinal?.toString(),\n        totalCostWei: event.totalCostWei?.toString(),\n        totalCostUsd: event.totalCostUsd?.toString(),\n        deploymentDuration: event.deploymentDuration,\n        confirmationTime: event.confirmationTime,\n        confirmations: event.confirmations,\n        errorMessage: event.errorMessage,\n        retryCount: event.retryCount,\n        parameters: event.parameters ? JSON.stringify(event.parameters) : undefined,\n        metadata: event.metadata ? JSON.stringify(event.metadata) : undefined,\n      });\n\n      // 記錄到 Prometheus\n      metricsCollector.recordDeployment(\n        event.type,\n        event.status === 'completed' ? 'success' : event.status === 'failed' ? 'failure' : 'pending',\n        event.deploymentDuration || 0,\n        event.errorMessage\n      );\n    } catch (error) {\n      console.error('Failed to log deployment:', error);\n    }\n  }\n\n  /**\n   * 記錄告警\n   */\n  async logAlert(event: AlertEvent): Promise<void> {\n    try {\n      await alertsDb.create({\n        title: event.title,\n        description: event.description,\n        level: event.level,\n        status: 'ACTIVE',\n        source: event.source,\n        sourceId: event.sourceId,\n        category: event.category,\n        tags: event.tags?.join(','),\n        priority: event.priority,\n        metadata: event.metadata ? JSON.stringify(event.metadata) : undefined,\n      });\n\n      // 記錄到 Prometheus\n      metricsCollector.recordAlert(event.level, event.source);\n    } catch (error) {\n      console.error('Failed to log alert:', error);\n    }\n  }\n\n  /**\n   * 記錄審計日誌\n   */\n  async logAudit(event: AuditLogEvent): Promise<void> {\n    try {\n      await auditLogsDb.create({\n        userId: event.userId,\n        action: event.action,\n        resource: event.resource,\n        resourceId: event.resourceId,\n        status: event.status,\n        statusCode: event.statusCode,\n        method: event.method,\n        endpoint: event.endpoint,\n        ipAddress: event.ipAddress,\n        userAgent: event.userAgent,\n        requestData: event.requestData ? JSON.stringify(event.requestData) : undefined,\n        responseData: event.responseData ? JSON.stringify(event.responseData) : undefined,\n        errorMessage: event.errorMessage,\n        duration: event.duration,\n        metadata: event.metadata ? JSON.stringify(event.metadata) : undefined,\n      });\n    } catch (error) {\n      console.error('Failed to log audit:', error);\n    }\n  }\n\n  /**\n   * 獲取部署日誌\n   */\n  async getDeploymentLogs(options?: {\n    type?: string;\n    status?: string;\n    limit?: number;\n    offset?: number;\n  }) {\n    try {\n      return await deploymentLogsDb.getList(options);\n    } catch (error) {\n      console.error('Failed to get deployment logs:', error);\n      return [];\n    }\n  }\n\n  /**\n   * 獲取告警\n   */\n  async getAlerts(options?: {\n    level?: string;\n    status?: string;\n    source?: string;\n    limit?: number;\n    offset?: number;\n  }) {\n    try {\n      return await alertsDb.getList(options);\n    } catch (error) {\n      console.error('Failed to get alerts:', error);\n      return [];\n    }\n  }\n\n  /**\n   * 獲取活躍告警\n   */\n  async getActiveAlerts(options?: { level?: string; limit?: number }) {\n    try {\n      return await alertsDb.getActive(options);\n    } catch (error) {\n      console.error('Failed to get active alerts:', error);\n      return [];\n    }\n  }\n\n  /**\n   * 確認告警\n   */\n  async acknowledgeAlert(alertId: string, userId: string): Promise<void> {\n    try {\n      await alertsDb.acknowledge(alertId, userId);\n\n      // 記錄審計日誌\n      await this.logAudit({\n        userId,\n        action: 'ACKNOWLEDGE_ALERT',\n        resource: 'alert',\n        resourceId: alertId,\n        status: 'success',\n      });\n    } catch (error) {\n      console.error('Failed to acknowledge alert:', error);\n    }\n  }\n\n  /**\n   * 解決告警\n   */\n  async resolveAlert(alertId: string, userId: string): Promise<void> {\n    try {\n      await alertsDb.resolve(alertId, userId);\n\n      // 記錄審計日誌\n      await this.logAudit({\n        userId,\n        action: 'RESOLVE_ALERT',\n        resource: 'alert',\n        resourceId: alertId,\n        status: 'success',\n      });\n    } catch (error) {\n      console.error('Failed to resolve alert:', error);\n    }\n  }\n\n  /**\n   * 獲取審計日誌\n   */\n  async getAuditLogs(options?: {\n    userId?: string;\n    action?: string;\n    resource?: string;\n    status?: string;\n    limit?: number;\n    offset?: number;\n  }) {\n    try {\n      return await auditLogsDb.getList(options);\n    } catch (error) {\n      console.error('Failed to get audit logs:', error);\n      return [];\n    }\n  }\n\n  /**\n   * 獲取部署統計\n   */\n  async getDeploymentStats(options?: { type?: string; days?: number }) {\n    try {\n      return await deploymentLogsDb.getStats(options);\n    } catch (error) {\n      console.error('Failed to get deployment stats:', error);\n      return [];\n    }\n  }\n}\n\nexport default new DeploymentLogger();\n
