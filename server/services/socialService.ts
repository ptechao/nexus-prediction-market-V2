/**\n * Social Service\n * \n * 社交功能：評論、點贊、分享、關注\n */\n\nimport Decimal from 'decimal.js';\n\n/**\n * 評論類型\n */\nexport enum CommentType {\n  MARKET = 'market',\n  TRADE = 'trade',\n  VAULT = 'vault',\n  USER = 'user',\n}\n\n/**\n * 評論信息\n */\nexport interface Comment {\n  id: string;\n  type: CommentType;\n  targetId: string;\n  userId: string;\n  content: string;\n  likes: number;\n  replies: number;\n  parentCommentId?: string;\n  createdAt: number;\n  updatedAt: number;\n  isEdited: boolean;\n  isDeleted: boolean;\n}\n\n/**\n * 點贊信息\n */\nexport interface Like {\n  id: string;\n  userId: string;\n  targetType: 'comment' | 'market' | 'trade' | 'vault' | 'user';\n  targetId: string;\n  createdAt: number;\n}\n\n/**\n * 分享信息\n */\nexport interface Share {\n  id: string;\n  userId: string;\n  targetType: 'market' | 'trade' | 'vault';\n  targetId: string;\n  platform: 'twitter' | 'facebook' | 'telegram' | 'wechat' | 'internal';\n  message?: string;\n  createdAt: number;\n}\n\n/**\n * 關注信息\n */\nexport interface Follow {\n  id: string;\n  followerId: string;\n  followingId: string;\n  createdAt: number;\n}\n\n/**\n * 通知信息\n */\nexport interface Notification {\n  id: string;\n  userId: string;\n  type: 'comment' | 'like' | 'follow' | 'share' | 'mention';\n  message: string;\n  targetId?: string;\n  targetType?: string;\n  fromUserId?: string;\n  read: boolean;\n  createdAt: number;\n}\n\n/**\n * Social Service\n */\nexport class SocialService {\n  private comments: Map<string, Comment> = new Map();\n  private likes: Map<string, Like> = new Map();\n  private shares: Map<string, Share> = new Map();\n  private follows: Map<string, Follow> = new Map();\n  private notifications: Map<string, Notification> = new Map();\n  private socialListeners: ((event: any) => void)[] = [];\n\n  /**\n   * 發表評論\n   */\n  createComment(\n    type: CommentType,\n    targetId: string,\n    userId: string,\n    content: string,\n    parentCommentId?: string\n  ): { commentId: string; error?: string } {\n    // 驗證參數\n    if (!content || content.trim().length === 0) {\n      return { commentId: '', error: 'Comment cannot be empty' };\n    }\n    if (content.length > 5000) {\n      return { commentId: '', error: 'Comment is too long' };\n    }\n\n    // 創建評論\n    const commentId = `comment-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n    const comment: Comment = {\n      id: commentId,\n      type,\n      targetId,\n      userId,\n      content: content.trim(),\n      likes: 0,\n      replies: 0,\n      parentCommentId,\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n      isEdited: false,\n      isDeleted: false,\n    };\n\n    this.comments.set(commentId, comment);\n\n    // 如果是回覆，更新父評論的回覆計數\n    if (parentCommentId) {\n      const parentComment = this.comments.get(parentCommentId);\n      if (parentComment) {\n        parentComment.replies += 1;\n      }\n    }\n\n    // 發送通知\n    this.notifySocialEvent({\n      type: 'comment_created',\n      comment,\n    });\n\n    return { commentId };\n  }\n\n  /**\n   * 編輯評論\n   */\n  editComment(commentId: string, userId: string, newContent: string): boolean {\n    const comment = this.comments.get(commentId);\n    if (!comment || comment.userId !== userId || comment.isDeleted) {\n      return false;\n    }\n\n    if (!newContent || newContent.trim().length === 0 || newContent.length > 5000) {\n      return false;\n    }\n\n    comment.content = newContent.trim();\n    comment.updatedAt = Date.now();\n    comment.isEdited = true;\n\n    return true;\n  }\n\n  /**\n   * 刪除評論\n   */\n  deleteComment(commentId: string, userId: string): boolean {\n    const comment = this.comments.get(commentId);\n    if (!comment || comment.userId !== userId) {\n      return false;\n    }\n\n    comment.isDeleted = true;\n    comment.updatedAt = Date.now();\n\n    // 如果是回覆，更新父評論的回覆計數\n    if (comment.parentCommentId) {\n      const parentComment = this.comments.get(comment.parentCommentId);\n      if (parentComment) {\n        parentComment.replies = Math.max(0, parentComment.replies - 1);\n      }\n    }\n\n    return true;\n  }\n\n  /**\n   * 獲取評論\n   */\n  getComments(\n    type: CommentType,\n    targetId: string,\n    limit: number = 20,\n    offset: number = 0\n  ): Comment[] {\n    const comments = Array.from(this.comments.values())\n      .filter((c) => c.type === type && c.targetId === targetId && !c.isDeleted && !c.parentCommentId)\n      .sort((a, b) => b.createdAt - a.createdAt)\n      .slice(offset, offset + limit);\n\n    return comments;\n  }\n\n  /**\n   * 獲取評論回覆\n   */\n  getCommentReplies(commentId: string, limit: number = 10): Comment[] {\n    return Array.from(this.comments.values())\n      .filter((c) => c.parentCommentId === commentId && !c.isDeleted)\n      .sort((a, b) => a.createdAt - b.createdAt)\n      .slice(0, limit);\n  }\n\n  /**\n   * 點贊\n   */\n  like(userId: string, targetType: 'comment' | 'market' | 'trade' | 'vault' | 'user', targetId: string): { likeId: string; error?: string } {\n    // 檢查是否已經點贊\n    const existing = Array.from(this.likes.values()).find(\n      (l) => l.userId === userId && l.targetType === targetType && l.targetId === targetId\n    );\n    if (existing) {\n      return { likeId: '', error: 'Already liked' };\n    }\n\n    // 創建點贊\n    const likeId = `like-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n    const like: Like = {\n      id: likeId,\n      userId,\n      targetType,\n      targetId,\n      createdAt: Date.now(),\n    };\n\n    this.likes.set(likeId, like);\n\n    // 更新目標的點贊計數\n    if (targetType === 'comment') {\n      const comment = this.comments.get(targetId);\n      if (comment) {\n        comment.likes += 1;\n      }\n    }\n\n    // 發送通知\n    this.notifySocialEvent({\n      type: 'like_created',\n      like,\n    });\n\n    return { likeId };\n  }\n\n  /**\n   * 取消點贊\n   */\n  unlike(userId: string, targetType: 'comment' | 'market' | 'trade' | 'vault' | 'user', targetId: string): boolean {\n    const like = Array.from(this.likes.values()).find(\n      (l) => l.userId === userId && l.targetType === targetType && l.targetId === targetId\n    );\n    if (!like) return false;\n\n    this.likes.delete(like.id);\n\n    // 更新目標的點贊計數\n    if (targetType === 'comment') {\n      const comment = this.comments.get(targetId);\n      if (comment) {\n        comment.likes = Math.max(0, comment.likes - 1);\n      }\n    }\n\n    return true;\n  }\n\n  /**\n   * 獲取點贊\n   */\n  getLikes(targetType: 'comment' | 'market' | 'trade' | 'vault' | 'user', targetId: string): Like[] {\n    return Array.from(this.likes.values()).filter(\n      (l) => l.targetType === targetType && l.targetId === targetId\n    );\n  }\n\n  /**\n   * 分享\n   */\n  share(\n    userId: string,\n    targetType: 'market' | 'trade' | 'vault',\n    targetId: string,\n    platform: 'twitter' | 'facebook' | 'telegram' | 'wechat' | 'internal',\n    message?: string\n  ): { shareId: string; error?: string } {\n    const shareId = `share-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n    const share: Share = {\n      id: shareId,\n      userId,\n      targetType,\n      targetId,\n      platform,\n      message,\n      createdAt: Date.now(),\n    };\n\n    this.shares.set(shareId, share);\n\n    // 發送通知\n    this.notifySocialEvent({\n      type: 'share_created',\n      share,\n    });\n\n    return { shareId };\n  }\n\n  /**\n   * 獲取分享\n   */\n  getShares(targetType: 'market' | 'trade' | 'vault', targetId: string): Share[] {\n    return Array.from(this.shares.values()).filter(\n      (s) => s.targetType === targetType && s.targetId === targetId\n    );\n  }\n\n  /**\n   * 關注用戶\n   */\n  follow(followerId: string, followingId: string): { followId: string; error?: string } {\n    if (followerId === followingId) {\n      return { followId: '', error: 'Cannot follow yourself' };\n    }\n\n    // 檢查是否已經關注\n    const existing = Array.from(this.follows.values()).find(\n      (f) => f.followerId === followerId && f.followingId === followingId\n    );\n    if (existing) {\n      return { followId: '', error: 'Already following' };\n    }\n\n    // 創建關注\n    const followId = `follow-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n    const follow: Follow = {\n      id: followId,\n      followerId,\n      followingId,\n      createdAt: Date.now(),\n    };\n\n    this.follows.set(followId, follow);\n\n    // 發送通知\n    this.notifySocialEvent({\n      type: 'follow_created',\n      follow,\n    });\n\n    return { followId };\n  }\n\n  /**\n   * 取消關注\n   */\n  unfollow(followerId: string, followingId: string): boolean {\n    const follow = Array.from(this.follows.values()).find(\n      (f) => f.followerId === followerId && f.followingId === followingId\n    );\n    if (!follow) return false;\n\n    this.follows.delete(follow.id);\n    return true;\n  }\n\n  /**\n   * 獲取關注列表\n   */\n  getFollowing(userId: string): Follow[] {\n    return Array.from(this.follows.values()).filter((f) => f.followerId === userId);\n  }\n\n  /**\n   * 獲取粉絲列表\n   */\n  getFollowers(userId: string): Follow[] {\n    return Array.from(this.follows.values()).filter((f) => f.followingId === userId);\n  }\n\n  /**\n   * 檢查是否關注\n   */\n  isFollowing(followerId: string, followingId: string): boolean {\n    return Array.from(this.follows.values()).some(\n      (f) => f.followerId === followerId && f.followingId === followingId\n    );\n  }\n\n  /**\n   * 創建通知\n   */\n  createNotification(\n    userId: string,\n    type: 'comment' | 'like' | 'follow' | 'share' | 'mention',\n    message: string,\n    targetId?: string,\n    targetType?: string,\n    fromUserId?: string\n  ): string {\n    const notificationId = `notification-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n    const notification: Notification = {\n      id: notificationId,\n      userId,\n      type,\n      message,\n      targetId,\n      targetType,\n      fromUserId,\n      read: false,\n      createdAt: Date.now(),\n    };\n\n    this.notifications.set(notificationId, notification);\n    return notificationId;\n  }\n\n  /**\n   * 獲取通知\n   */\n  getNotifications(userId: string, limit: number = 20, offset: number = 0): Notification[] {\n    return Array.from(this.notifications.values())\n      .filter((n) => n.userId === userId)\n      .sort((a, b) => b.createdAt - a.createdAt)\n      .slice(offset, offset + limit);\n  }\n\n  /**\n   * 標記通知為已讀\n   */\n  markNotificationAsRead(notificationId: string): boolean {\n    const notification = this.notifications.get(notificationId);\n    if (!notification) return false;\n\n    notification.read = true;\n    return true;\n  }\n\n  /**\n   * 獲取未讀通知計數\n   */\n  getUnreadNotificationCount(userId: string): number {\n    return Array.from(this.notifications.values()).filter(\n      (n) => n.userId === userId && !n.read\n    ).length;\n  }\n\n  /**\n   * 註冊社交事件監聽器\n   */\n  onSocialEvent(listener: (event: any) => void): void {\n    this.socialListeners.push(listener);\n  }\n\n  /**\n   * 移除社交事件監聽器\n   */\n  offSocialEvent(listener: (event: any) => void): void {\n    const index = this.socialListeners.indexOf(listener);\n    if (index !== -1) {\n      this.socialListeners.splice(index, 1);\n    }\n  }\n\n  /**\n   * 通知社交事件\n   */\n  private notifySocialEvent(event: any): void {\n    for (const listener of this.socialListeners) {\n      try {\n        listener(event);\n      } catch (error) {\n        console.error('[Social Service] Error in social listener:', error);\n      }\n    }\n  }\n\n  /**\n   * 獲取統計信息\n   */\n  getStats() {\n    return {\n      totalComments: this.comments.size,\n      totalLikes: this.likes.size,\n      totalShares: this.shares.size,\n      totalFollows: this.follows.size,\n      totalNotifications: this.notifications.size,\n    };\n  }\n}\n\n// 導出單例\nexport const socialService = new SocialService();\n
