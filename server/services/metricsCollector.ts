/**\n * Prometheus 指標收集服務\n * \n * 收集和暴露應用性能指標。\n * 支持部署、Gas、交易和告警指標。\n */\n\nimport { register, Counter, Gauge, Histogram, Summary } from 'prom-client';\n\n/**\n * 指標收集器\n */\nexport class MetricsCollector {\n  // 部署指標\n  private deploymentCounter: Counter;\n  private deploymentDurationHistogram: Histogram;\n  private deploymentSuccessRateGauge: Gauge;\n  private deploymentFailureReasonCounter: Counter;\n\n  // Gas 指標\n  private gasPriceGauge: Gauge;\n  private gasEstimationDurationHistogram: Histogram;\n  private gasEstimationErrorCounter: Counter;\n  private gasCostSummary: Summary;\n\n  // 交易指標\n  private transactionConfirmationTimeHistogram: Histogram;\n  private transactionConfirmationRateGauge: Gauge;\n  private transactionFailureCounter: Counter;\n\n  // 告警指標\n  private alertCounter: Counter;\n  private alertLevelCounter: Counter;\n  private alertResponseTimeHistogram: Histogram;\n\n  // API 指標\n  private apiRequestDurationHistogram: Histogram;\n  private apiErrorCounter: Counter;\n  private apiRequestsInFlightGauge: Gauge;\n\n  constructor() {\n    // 部署指標\n    this.deploymentCounter = new Counter({\n      name: 'nexus_deployments_total',\n      help: 'Total number of deployments',\n      labelNames: ['type', 'status'],\n    });\n\n    this.deploymentDurationHistogram = new Histogram({\n      name: 'nexus_deployment_duration_seconds',\n      help: 'Deployment duration in seconds',\n      labelNames: ['type'],\n      buckets: [10, 30, 60, 120, 300, 600, 1200],\n    });\n\n    this.deploymentSuccessRateGauge = new Gauge({\n      name: 'nexus_deployment_success_rate',\n      help: 'Deployment success rate (0-100)',\n      labelNames: ['type'],\n    });\n\n    this.deploymentFailureReasonCounter = new Counter({\n      name: 'nexus_deployment_failures_total',\n      help: 'Total deployment failures by reason',\n      labelNames: ['reason'],\n    });\n\n    // Gas 指標\n    this.gasPriceGauge = new Gauge({\n      name: 'nexus_gas_price_gwei',\n      help: 'Current gas price in Gwei',\n    });\n\n    this.gasEstimationDurationHistogram = new Histogram({\n      name: 'nexus_gas_estimation_duration_ms',\n      help: 'Gas estimation duration in milliseconds',\n      buckets: [10, 50, 100, 500, 1000, 5000],\n    });\n\n    this.gasEstimationErrorCounter = new Counter({\n      name: 'nexus_gas_estimation_errors_total',\n      help: 'Total gas estimation errors',\n    });\n\n    this.gasCostSummary = new Summary({\n      name: 'nexus_gas_cost_usd',\n      help: 'Gas cost in USD',\n      percentiles: [0.5, 0.9, 0.95, 0.99],\n    });\n\n    // 交易指標\n    this.transactionConfirmationTimeHistogram = new Histogram({\n      name: 'nexus_transaction_confirmation_time_seconds',\n      help: 'Transaction confirmation time in seconds',\n      buckets: [10, 30, 60, 120, 300, 600],\n    });\n\n    this.transactionConfirmationRateGauge = new Gauge({\n      name: 'nexus_transaction_confirmation_rate',\n      help: 'Transaction confirmation rate (0-100)',\n    });\n\n    this.transactionFailureCounter = new Counter({\n      name: 'nexus_transaction_failures_total',\n      help: 'Total transaction failures',\n      labelNames: ['reason'],\n    });\n\n    // 告警指標\n    this.alertCounter = new Counter({\n      name: 'nexus_alerts_total',\n      help: 'Total alerts triggered',\n      labelNames: ['level', 'source'],\n    });\n\n    this.alertLevelCounter = new Counter({\n      name: 'nexus_alert_levels_total',\n      help: 'Alerts by level',\n      labelNames: ['level'],\n    });\n\n    this.alertResponseTimeHistogram = new Histogram({\n      name: 'nexus_alert_response_time_seconds',\n      help: 'Alert response time in seconds',\n      buckets: [1, 5, 10, 30, 60, 300],\n    });\n\n    // API 指標\n    this.apiRequestDurationHistogram = new Histogram({\n      name: 'nexus_api_request_duration_ms',\n      help: 'API request duration in milliseconds',\n      labelNames: ['method', 'endpoint'],\n      buckets: [10, 50, 100, 500, 1000, 5000],\n    });\n\n    this.apiErrorCounter = new Counter({\n      name: 'nexus_api_errors_total',\n      help: 'Total API errors',\n      labelNames: ['method', 'endpoint', 'status'],\n    });\n\n    this.apiRequestsInFlightGauge = new Gauge({\n      name: 'nexus_api_requests_in_flight',\n      help: 'Number of API requests in flight',\n      labelNames: ['method', 'endpoint'],\n    });\n  }\n\n  /**\n   * 記錄部署\n   */\n  recordDeployment(type: string, status: 'success' | 'failure', duration: number, reason?: string): void {\n    this.deploymentCounter.inc({ type, status });\n    this.deploymentDurationHistogram.observe({ type }, duration / 1000);\n\n    if (status === 'failure' && reason) {\n      this.deploymentFailureReasonCounter.inc({ reason });\n    }\n  }\n\n  /**\n   * 更新部署成功率\n   */\n  updateDeploymentSuccessRate(type: string, rate: number): void {\n    this.deploymentSuccessRateGauge.set({ type }, rate);\n  }\n\n  /**\n   * 記錄 Gas 價格\n   */\n  recordGasPrice(priceGwei: number): void {\n    this.gasPriceGauge.set(priceGwei);\n  }\n\n  /**\n   * 記錄 Gas 估算\n   */\n  recordGasEstimation(duration: number, costUsd: number, error?: boolean): void {\n    if (error) {\n      this.gasEstimationErrorCounter.inc();\n    } else {\n      this.gasEstimationDurationHistogram.observe(duration);\n      this.gasCostSummary.observe(costUsd);\n    }\n  }\n\n  /**\n   * 記錄交易確認\n   */\n  recordTransactionConfirmation(confirmationTime: number, success: boolean, reason?: string): void {\n    if (success) {\n      this.transactionConfirmationTimeHistogram.observe(confirmationTime / 1000);\n    } else {\n      this.transactionFailureCounter.inc({ reason: reason || 'unknown' });\n    }\n  }\n\n  /**\n   * 更新交易確認率\n   */\n  updateTransactionConfirmationRate(rate: number): void {\n    this.transactionConfirmationRateGauge.set(rate);\n  }\n\n  /**\n   * 記錄告警\n   */\n  recordAlert(level: 'INFO' | 'WARNING' | 'CRITICAL', source: string, responseTime?: number): void {\n    this.alertCounter.inc({ level, source });\n    this.alertLevelCounter.inc({ level });\n\n    if (responseTime) {\n      this.alertResponseTimeHistogram.observe(responseTime / 1000);\n    }\n  }\n\n  /**\n   * 記錄 API 請求\n   */\n  recordApiRequest(\n    method: string,\n    endpoint: string,\n    duration: number,\n    status?: number,\n    error?: boolean\n  ): void {\n    this.apiRequestDurationHistogram.observe({ method, endpoint }, duration);\n\n    if (error && status) {\n      this.apiErrorCounter.inc({ method, endpoint, status: status.toString() });\n    }\n  }\n\n  /**\n   * 增加 API 請求計數\n   */\n  incrementApiRequestsInFlight(method: string, endpoint: string): void {\n    this.apiRequestsInFlightGauge.inc({ method, endpoint });\n  }\n\n  /**\n   * 減少 API 請求計數\n   */\n  decrementApiRequestsInFlight(method: string, endpoint: string): void {\n    this.apiRequestsInFlightGauge.dec({ method, endpoint });\n  }\n\n  /**\n   * 獲取所有指標\n   */\n  getMetrics(): string {\n    return register.metrics();\n  }\n\n  /**\n   * 獲取指標內容類型\n   */\n  getMetricsContentType(): string {\n    return register.contentType;\n  }\n}\n\nexport default new MetricsCollector();\n
