/**\n * Follower Manager 服務\n * \n * 跟隨者管理、跟隨關係、跟隨統計、跟隨控制\n */\n\nimport Decimal from 'decimal.js';\n\n/**\n * 跟隨狀態\n */\nexport enum FollowStatus {\n  ACTIVE = 'active',\n  PAUSED = 'paused',\n  STOPPED = 'stopped',\n}\n\n/**\n * 跟隨關係\n */\nexport interface FollowRelation {\n  id: string;\n  followerId: string; // 跟隨者\n  traderVaultId: string; // 被跟隨的 Vault\n  status: FollowStatus;\n  investmentAmount: Decimal; // 投資金額\n  allocationPercent: Decimal; // 分配百分比\n  startedAt: number;\n  updatedAt: number;\n}\n\n/**\n * 跟隨統計\n */\nexport interface FollowStats {\n  relationId: string;\n  followerId: string;\n  traderVaultId: string;\n  totalCopiedTrades: number; // 複製交易數\n  successfulTrades: number; // 成功交易數\n  failedTrades: number; // 失敗交易數\n  totalPnL: Decimal; // 總損益\n  totalReturn: Decimal; // 總收益率\n  winRate: Decimal; // 勝率\n  averageReturn: Decimal; // 平均收益\n  maxDrawdown: Decimal; // 最大回撤\n  lastUpdated: number;\n}\n\n/**\n * 跟隨設置\n */\nexport interface FollowSettings {\n  relationId: string;\n  maxTradeSize: Decimal; // 最大交易規模\n  minTradeSize: Decimal; // 最小交易規模\n  maxDailyLoss: Decimal; // 最大日虧損\n  stopLossPercent: Decimal; // 止損百分比\n  takeProfitPercent: Decimal; // 止盈百分比\n  autoRebalance: boolean; // 自動再平衡\n  rebalanceInterval: number; // 再平衡間隔（分鐘）\n}\n\n/**\n * Follower Manager 服務\n */\nexport class FollowerManager {\n  private followRelations: Map<string, FollowRelation> = new Map();\n  private followStats: Map<string, FollowStats> = new Map();\n  private followSettings: Map<string, FollowSettings> = new Map();\n  private traderFollowers: Map<string, string[]> = new Map(); // Vault ID -> Follower IDs\n  private followerTraders: Map<string, string[]> = new Map(); // Follower ID -> Vault IDs\n  private followListeners: ((relation: FollowRelation) => void)[] = [];\n  private statsListeners: ((stats: FollowStats) => void)[] = [];\n\n  /**\n   * 開始跟隨\n   */\n  startFollowing(\n    followerId: string,\n    traderVaultId: string,\n    investmentAmount: Decimal,\n    allocationPercent: Decimal\n  ): { relationId: string; error?: string } {\n    // 驗證參數\n    if (investmentAmount.lessThanOrEqualTo(0)) {\n      return { relationId: '', error: 'Investment amount must be positive' };\n    }\n    if (allocationPercent.lessThan(0) || allocationPercent.greaterThan(100)) {\n      return { relationId: '', error: 'Allocation percent must be between 0 and 100' };\n    }\n\n    // 檢查是否已經跟隨\n    const existing = Array.from(this.followRelations.values()).find(\n      (r) => r.followerId === followerId && r.traderVaultId === traderVaultId && r.status !== FollowStatus.STOPPED\n    );\n    if (existing) {\n      return { relationId: '', error: 'Already following this trader' };\n    }\n\n    // 創建跟隨關係\n    const relationId = `follow-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n    const relation: FollowRelation = {\n      id: relationId,\n      followerId,\n      traderVaultId,\n      status: FollowStatus.ACTIVE,\n      investmentAmount,\n      allocationPercent,\n      startedAt: Date.now(),\n      updatedAt: Date.now(),\n    };\n\n    this.followRelations.set(relationId, relation);\n\n    // 更新映射\n    if (!this.traderFollowers.has(traderVaultId)) {\n      this.traderFollowers.set(traderVaultId, []);\n    }\n    this.traderFollowers.get(traderVaultId)!.push(followerId);\n\n    if (!this.followerTraders.has(followerId)) {\n      this.followerTraders.set(followerId, []);\n    }\n    this.followerTraders.get(followerId)!.push(traderVaultId);\n\n    // 創建統計記錄\n    const stats: FollowStats = {\n      relationId,\n      followerId,\n      traderVaultId,\n      totalCopiedTrades: 0,\n      successfulTrades: 0,\n      failedTrades: 0,\n      totalPnL: new Decimal('0'),\n      totalReturn: new Decimal('0'),\n      winRate: new Decimal('0'),\n      averageReturn: new Decimal('0'),\n      maxDrawdown: new Decimal('0'),\n      lastUpdated: Date.now(),\n    };\n    this.followStats.set(relationId, stats);\n\n    // 創建設置\n    const settings: FollowSettings = {\n      relationId,\n      maxTradeSize: investmentAmount.times(0.2), // 最多投入 20%\n      minTradeSize: investmentAmount.times(0.01), // 最少投入 1%\n      maxDailyLoss: investmentAmount.times(0.05), // 最大日虧損 5%\n      stopLossPercent: new Decimal('0.1'), // 10% 止損\n      takeProfitPercent: new Decimal('0.2'), // 20% 止盈\n      autoRebalance: true,\n      rebalanceInterval: 60, // 每小時再平衡\n    };\n    this.followSettings.set(relationId, settings);\n\n    this.notifyFollowListeners(relation);\n\n    return { relationId };\n  }\n\n  /**\n   * 停止跟隨\n   */\n  stopFollowing(relationId: string): boolean {\n    const relation = this.followRelations.get(relationId);\n    if (!relation) return false;\n\n    relation.status = FollowStatus.STOPPED;\n    relation.updatedAt = Date.now();\n\n    // 更新映射\n    const followers = this.traderFollowers.get(relation.traderVaultId) || [];\n    const index = followers.indexOf(relation.followerId);\n    if (index !== -1) {\n      followers.splice(index, 1);\n    }\n\n    const traders = this.followerTraders.get(relation.followerId) || [];\n    const traderIndex = traders.indexOf(relation.traderVaultId);\n    if (traderIndex !== -1) {\n      traders.splice(traderIndex, 1);\n    }\n\n    this.notifyFollowListeners(relation);\n    return true;\n  }\n\n  /**\n   * 暫停跟隨\n   */\n  pauseFollowing(relationId: string): boolean {\n    const relation = this.followRelations.get(relationId);\n    if (!relation) return false;\n\n    relation.status = FollowStatus.PAUSED;\n    relation.updatedAt = Date.now();\n\n    this.notifyFollowListeners(relation);\n    return true;\n  }\n\n  /**\n   * 恢復跟隨\n   */\n  resumeFollowing(relationId: string): boolean {\n    const relation = this.followRelations.get(relationId);\n    if (!relation) return false;\n\n    relation.status = FollowStatus.ACTIVE;\n    relation.updatedAt = Date.now();\n\n    this.notifyFollowListeners(relation);\n    return true;\n  }\n\n  /**\n   * 更新跟隨統計\n   */\n  updateFollowStats(\n    relationId: string,\n    tradeSuccess: boolean,\n    pnL: Decimal,\n    returnPercent: Decimal\n  ): void {\n    const stats = this.followStats.get(relationId);\n    if (!stats) return;\n\n    stats.totalCopiedTrades++;\n    if (tradeSuccess) {\n      stats.successfulTrades++;\n    } else {\n      stats.failedTrades++;\n    }\n\n    stats.totalPnL = stats.totalPnL.plus(pnL);\n    stats.totalReturn = stats.totalReturn.plus(returnPercent);\n    stats.winRate = new Decimal(stats.successfulTrades).dividedBy(stats.totalCopiedTrades);\n    stats.averageReturn = stats.totalReturn.dividedBy(stats.totalCopiedTrades);\n    stats.lastUpdated = Date.now();\n\n    // 更新最大回撤\n    if (pnL.lessThan(stats.maxDrawdown)) {\n      stats.maxDrawdown = pnL;\n    }\n\n    this.notifyStatsListeners(stats);\n  }\n\n  /**\n   * 獲取跟隨關係\n   */\n  getFollowRelation(relationId: string): FollowRelation | null {\n    return this.followRelations.get(relationId) || null;\n  }\n\n  /**\n   * 獲取跟隨者的跟隨列表\n   */\n  getFollowerFollowings(followerId: string): FollowRelation[] {\n    return Array.from(this.followRelations.values()).filter(\n      (r) => r.followerId === followerId && r.status !== FollowStatus.STOPPED\n    );\n  }\n\n  /**\n   * 獲取 Vault 的跟隨者列表\n   */\n  getVaultFollowers(vaultId: string): FollowRelation[] {\n    return Array.from(this.followRelations.values()).filter(\n      (r) => r.traderVaultId === vaultId && r.status !== FollowStatus.STOPPED\n    );\n  }\n\n  /**\n   * 獲取跟隨統計\n   */\n  getFollowStats(relationId: string): FollowStats | null {\n    return this.followStats.get(relationId) || null;\n  }\n\n  /**\n   * 獲取跟隨設置\n   */\n  getFollowSettings(relationId: string): FollowSettings | null {\n    return this.followSettings.get(relationId) || null;\n  }\n\n  /**\n   * 更新跟隨設置\n   */\n  updateFollowSettings(relationId: string, settings: Partial<FollowSettings>): boolean {\n    const currentSettings = this.followSettings.get(relationId);\n    if (!currentSettings) return false;\n\n    Object.assign(currentSettings, settings);\n    return true;\n  }\n\n  /**\n   * 獲取跟隨者數量\n   */\n  getFollowerCount(vaultId: string): number {\n    return this.traderFollowers.get(vaultId)?.length || 0;\n  }\n\n  /**\n   * 獲取跟隨的 Vault 數量\n   */\n  getFollowingCount(followerId: string): number {\n    return this.followerTraders.get(followerId)?.length || 0;\n  }\n\n  /**\n   * 註冊跟隨監聽器\n   */\n  onFollowUpdate(listener: (relation: FollowRelation) => void): void {\n    this.followListeners.push(listener);\n  }\n\n  /**\n   * 移除跟隨監聽器\n   */\n  offFollowUpdate(listener: (relation: FollowRelation) => void): void {\n    const index = this.followListeners.indexOf(listener);\n    if (index !== -1) {\n      this.followListeners.splice(index, 1);\n    }\n  }\n\n  /**\n   * 通知跟隨監聽器\n   */\n  private notifyFollowListeners(relation: FollowRelation): void {\n    for (const listener of this.followListeners) {\n      try {\n        listener(relation);\n      } catch (error) {\n        console.error('[Follower Manager] Error in follow listener:', error);\n      }\n    }\n  }\n\n  /**\n   * 註冊統計監聽器\n   */\n  onStatsUpdate(listener: (stats: FollowStats) => void): void {\n    this.statsListeners.push(listener);\n  }\n\n  /**\n   * 移除統計監聽器\n   */\n  offStatsUpdate(listener: (stats: FollowStats) => void): void {\n    const index = this.statsListeners.indexOf(listener);\n    if (index !== -1) {\n      this.statsListeners.splice(index, 1);\n    }\n  }\n\n  /**\n   * 通知統計監聽器\n   */\n  private notifyStatsListeners(stats: FollowStats): void {\n    for (const listener of this.statsListeners) {\n      try {\n        listener(stats);\n      } catch (error) {\n        console.error('[Follower Manager] Error in stats listener:', error);\n      }\n    }\n  }\n\n  /**\n   * 獲取統計信息\n   */\n  getStats() {\n    const activeFollows = Array.from(this.followRelations.values()).filter((r) => r.status === FollowStatus.ACTIVE).length;\n    const totalFollows = this.followRelations.size;\n    const totalFollowers = new Set(\n      Array.from(this.followRelations.values()).map((r) => r.followerId)\n    ).size;\n    const totalTraders = new Set(\n      Array.from(this.followRelations.values()).map((r) => r.traderVaultId)\n    ).size;\n\n    return {\n      activeFollows,\n      totalFollows,\n      totalFollowers,\n      totalTraders,\n    };\n  }\n}\n\n// 導出單例\nexport const followerManager = new FollowerManager();\n
