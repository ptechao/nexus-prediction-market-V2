/**\n * Live Stream Service\n * \n * ç›´æ’­åŠŸèƒ½ï¼šç›´æ’­å®¤ã€èŠå¤©ã€äº’å‹•ã€çµ±è¨ˆ\n */\n\nimport Decimal from 'decimal.js';\n\n/**\n * ç›´æ’­ç‹€æ…‹\n */\nexport enum StreamStatus {\n  OFFLINE = 'offline',\n  LIVE = 'live',\n  PAUSED = 'paused',\n  ENDED = 'ended',\n}\n\n/**\n * ç›´æ’­ä¿¡æ¯\n */\nexport interface LiveStream {\n  id: string;\n  hostId: string;\n  title: string;\n  description?: string;\n  category: string;\n  status: StreamStatus;\n  viewerCount: number;\n  likeCount: number;\n  startedAt: number;\n  endedAt?: number;\n  duration: number; // ç§’\n  thumbnail?: string;\n  tags: string[];\n  isVerified: boolean;\n}\n\n/**\n * ç›´æ’­èŠå¤©æ¶ˆæ¯\n */\nexport interface ChatMessage {\n  id: string;\n  streamId: string;\n  userId: string;\n  username: string;\n  avatar?: string;\n  message: string;\n  color?: string;\n  isModerator: boolean;\n  isHost: boolean;\n  timestamp: number;\n  likes: number;\n}\n\n/**\n * ç›´æ’­ç¦®ç‰©\n */\nexport interface Gift {\n  id: string;\n  name: string;\n  emoji: string;\n  price: Decimal;\n  icon?: string;\n}\n\n/**\n * ç¦®ç‰©è´ˆé€è¨˜éŒ„\n */\nexport interface GiftRecord {\n  id: string;\n  streamId: string;\n  senderId: string;\n  giftId: string;\n  quantity: number;\n  totalPrice: Decimal;\n  message?: string;\n  timestamp: number;\n}\n\n/**\n * ç›´æ’­äº’å‹•\n */\nexport interface StreamInteraction {\n  id: string;\n  streamId: string;\n  userId: string;\n  type: 'like' | 'gift' | 'follow' | 'share' | 'comment';\n  data: any;\n  timestamp: number;\n}\n\n/**\n * Live Stream Service\n */\nexport class LiveStreamService {\n  private streams: Map<string, LiveStream> = new Map();\n  private chatMessages: Map<string, ChatMessage[]> = new Map();\n  private gifts: Map<string, Gift> = new Map();\n  private giftRecords: Map<string, GiftRecord> = new Map();\n  private interactions: Map<string, StreamInteraction> = new Map();\n  private streamListeners: Map<string, ((event: any) => void)[]> = new Map();\n  private streamViewers: Map<string, Set<string>> = new Map(); // streamId -> Set<userId>\n\n  constructor() {\n    this.initializeGifts();\n  }\n\n  /**\n   * åˆå§‹åŒ–ç¦®ç‰©\n   */\n  private initializeGifts(): void {\n    const gifts: Gift[] = [\n      { id: 'gift-1', name: 'Like', emoji: 'ğŸ‘', price: new Decimal('0') },\n      { id: 'gift-2', name: 'Heart', emoji: 'â¤ï¸', price: new Decimal('0.1') },\n      { id: 'gift-3', name: 'Fire', emoji: 'ğŸ”¥', price: new Decimal('0.5') },\n      { id: 'gift-4', name: 'Diamond', emoji: 'ğŸ’', price: new Decimal('1') },\n      { id: 'gift-5', name: 'Crown', emoji: 'ğŸ‘‘', price: new Decimal('5') },\n      { id: 'gift-6', name: 'Rocket', emoji: 'ğŸš€', price: new Decimal('10') },\n    ];\n\n    for (const gift of gifts) {\n      this.gifts.set(gift.id, gift);\n    }\n  }\n\n  /**\n   * é–‹å§‹ç›´æ’­\n   */\n  startStream(\n    hostId: string,\n    title: string,\n    category: string,\n    description?: string,\n    tags?: string[]\n  ): { streamId: string; error?: string } {\n    // é©—è­‰åƒæ•¸\n    if (!title || title.length === 0) {\n      return { streamId: '', error: 'Title is required' };\n    }\n    if (title.length > 200) {\n      return { streamId: '', error: 'Title is too long' };\n    }\n    if (!category || category.length === 0) {\n      return { streamId: '', error: 'Category is required' };\n    }\n\n    // æª¢æŸ¥ä¸»æ’­æ˜¯å¦å·²æœ‰ç›´æ’­\n    const existing = Array.from(this.streams.values()).find(\n      (s) => s.hostId === hostId && s.status === StreamStatus.LIVE\n    );\n    if (existing) {\n      return { streamId: '', error: 'Host already has an active stream' };\n    }\n\n    // å‰µå»ºç›´æ’­\n    const streamId = `stream-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n    const stream: LiveStream = {\n      id: streamId,\n      hostId,\n      title,\n      description,\n      category,\n      status: StreamStatus.LIVE,\n      viewerCount: 0,\n      likeCount: 0,\n      startedAt: Date.now(),\n      duration: 0,\n      tags: tags || [],\n      isVerified: false,\n    };\n\n    this.streams.set(streamId, stream);\n    this.chatMessages.set(streamId, []);\n    this.streamViewers.set(streamId, new Set());\n\n    // ç™¼é€äº‹ä»¶\n    this.notifyStreamEvent(streamId, {\n      type: 'stream_started',\n      stream,\n    });\n\n    return { streamId };\n  }\n\n  /**\n   * çµæŸç›´æ’­\n   */\n  endStream(streamId: string, hostId: string): boolean {\n    const stream = this.streams.get(streamId);\n    if (!stream || stream.hostId !== hostId) return false;\n\n    stream.status = StreamStatus.ENDED;\n    stream.endedAt = Date.now();\n    stream.duration = Math.floor((stream.endedAt - stream.startedAt) / 1000);\n\n    // ç™¼é€äº‹ä»¶\n    this.notifyStreamEvent(streamId, {\n      type: 'stream_ended',\n      stream,\n    });\n\n    return true;\n  }\n\n  /**\n   * æš«åœç›´æ’­\n   */\n  pauseStream(streamId: string, hostId: string): boolean {\n    const stream = this.streams.get(streamId);\n    if (!stream || stream.hostId !== hostId || stream.status !== StreamStatus.LIVE) return false;\n\n    stream.status = StreamStatus.PAUSED;\n\n    // ç™¼é€äº‹ä»¶\n    this.notifyStreamEvent(streamId, {\n      type: 'stream_paused',\n      stream,\n    });\n\n    return true;\n  }\n\n  /**\n   * æ¢å¾©ç›´æ’­\n   */\n  resumeStream(streamId: string, hostId: string): boolean {\n    const stream = this.streams.get(streamId);\n    if (!stream || stream.hostId !== hostId || stream.status !== StreamStatus.PAUSED) return false;\n\n    stream.status = StreamStatus.LIVE;\n\n    // ç™¼é€äº‹ä»¶\n    this.notifyStreamEvent(streamId, {\n      type: 'stream_resumed',\n      stream,\n    });\n\n    return true;\n  }\n\n  /**\n   * åŠ å…¥ç›´æ’­\n   */\n  joinStream(streamId: string, userId: string): boolean {\n    const stream = this.streams.get(streamId);\n    if (!stream || stream.status !== StreamStatus.LIVE) return false;\n\n    const viewers = this.streamViewers.get(streamId);\n    if (!viewers) return false;\n\n    viewers.add(userId);\n    stream.viewerCount = viewers.size;\n\n    // ç™¼é€äº‹ä»¶\n    this.notifyStreamEvent(streamId, {\n      type: 'viewer_joined',\n      userId,\n      viewerCount: stream.viewerCount,\n    });\n\n    return true;\n  }\n\n  /**\n   * é›¢é–‹ç›´æ’­\n   */\n  leaveStream(streamId: string, userId: string): boolean {\n    const viewers = this.streamViewers.get(streamId);\n    if (!viewers) return false;\n\n    viewers.delete(userId);\n\n    const stream = this.streams.get(streamId);\n    if (stream) {\n      stream.viewerCount = viewers.size;\n\n      // ç™¼é€äº‹ä»¶\n      this.notifyStreamEvent(streamId, {\n        type: 'viewer_left',\n        userId,\n        viewerCount: stream.viewerCount,\n      });\n    }\n\n    return true;\n  }\n\n  /**\n   * ç™¼é€èŠå¤©æ¶ˆæ¯\n   */\n  sendChatMessage(\n    streamId: string,\n    userId: string,\n    username: string,\n    message: string,\n    isModerator: boolean = false,\n    isHost: boolean = false,\n    avatar?: string,\n    color?: string\n  ): { messageId: string; error?: string } {\n    // é©—è­‰åƒæ•¸\n    if (!message || message.trim().length === 0) {\n      return { messageId: '', error: 'Message cannot be empty' };\n    }\n    if (message.length > 500) {\n      return { messageId: '', error: 'Message is too long' };\n    }\n\n    // å‰µå»ºæ¶ˆæ¯\n    const messageId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n    const chatMessage: ChatMessage = {\n      id: messageId,\n      streamId,\n      userId,\n      username,\n      avatar,\n      message: message.trim(),\n      color,\n      isModerator,\n      isHost,\n      timestamp: Date.now(),\n      likes: 0,\n    };\n\n    const messages = this.chatMessages.get(streamId) || [];\n    messages.push(chatMessage);\n    this.chatMessages.set(streamId, messages);\n\n    // ç™¼é€äº‹ä»¶\n    this.notifyStreamEvent(streamId, {\n      type: 'chat_message',\n      message: chatMessage,\n    });\n\n    return { messageId };\n  }\n\n  /**\n   * ç²å–èŠå¤©æ¶ˆæ¯\n   */\n  getChatMessages(streamId: string, limit: number = 50): ChatMessage[] {\n    const messages = this.chatMessages.get(streamId) || [];\n    return messages.slice(-limit);\n  }\n\n  /**\n   * é»è´Šç›´æ’­\n   */\n  likeStream(streamId: string, userId: string): boolean {\n    const stream = this.streams.get(streamId);\n    if (!stream) return false;\n\n    stream.likeCount += 1;\n\n    // ç™¼é€äº‹ä»¶\n    this.notifyStreamEvent(streamId, {\n      type: 'stream_liked',\n      userId,\n      likeCount: stream.likeCount,\n    });\n\n    return true;\n  }\n\n  /**\n   * è´ˆé€ç¦®ç‰©\n   */\n  sendGift(\n    streamId: string,\n    senderId: string,\n    giftId: string,\n    quantity: number = 1,\n    message?: string\n  ): { recordId: string; error?: string } {\n    // é©—è­‰ç¦®ç‰©\n    const gift = this.gifts.get(giftId);\n    if (!gift) {\n      return { recordId: '', error: 'Gift not found' };\n    }\n\n    // é©—è­‰æ•¸é‡\n    if (quantity < 1 || quantity > 100) {\n      return { recordId: '', error: 'Invalid quantity' };\n    }\n\n    // è¨ˆç®—ç¸½åƒ¹\n    const totalPrice = gift.price.times(quantity);\n\n    // å‰µå»ºè´ˆé€è¨˜éŒ„\n    const recordId = `gift-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n    const record: GiftRecord = {\n      id: recordId,\n      streamId,\n      senderId,\n      giftId,\n      quantity,\n      totalPrice,\n      message,\n      timestamp: Date.now(),\n    };\n\n    this.giftRecords.set(recordId, record);\n\n    // ç™¼é€äº‹ä»¶\n    this.notifyStreamEvent(streamId, {\n      type: 'gift_sent',\n      record,\n    });\n\n    return { recordId };\n  }\n\n  /**\n   * ç²å–ç›´æ’­\n   */\n  getStream(streamId: string): LiveStream | null {\n    return this.streams.get(streamId) || null;\n  }\n\n  /**\n   * ç²å–ä¸»æ’­çš„ç›´æ’­\n   */\n  getHostStreams(hostId: string): LiveStream[] {\n    return Array.from(this.streams.values()).filter((s) => s.hostId === hostId);\n  }\n\n  /**\n   * ç²å–ç›´æ’­åˆ—è¡¨\n   */\n  getStreams(category?: string, limit: number = 20): LiveStream[] {\n    let streams = Array.from(this.streams.values()).filter((s) => s.status === StreamStatus.LIVE);\n\n    if (category) {\n      streams = streams.filter((s) => s.category === category);\n    }\n\n    return streams.sort((a, b) => b.viewerCount - a.viewerCount).slice(0, limit);\n  }\n\n  /**\n   * ç²å–ç¦®ç‰©åˆ—è¡¨\n   */\n  getGifts(): Gift[] {\n    return Array.from(this.gifts.values());\n  }\n\n  /**\n   * ç²å–ç›´æ’­çš„ç¦®ç‰©è¨˜éŒ„\n   */\n  getGiftRecords(streamId: string): GiftRecord[] {\n    return Array.from(this.giftRecords.values())\n      .filter((r) => r.streamId === streamId)\n      .sort((a, b) => b.timestamp - a.timestamp);\n  }\n\n  /**\n   * ç²å–ç›´æ’­çš„è§€çœ¾\n   */\n  getViewers(streamId: string): string[] {\n    const viewers = this.streamViewers.get(streamId);\n    return viewers ? Array.from(viewers) : [];\n  }\n\n  /**\n   * è¨»å†Šç›´æ’­äº‹ä»¶ç›£è½å™¨\n   */\n  onStreamEvent(streamId: string, listener: (event: any) => void): void {\n    if (!this.streamListeners.has(streamId)) {\n      this.streamListeners.set(streamId, []);\n    }\n    this.streamListeners.get(streamId)!.push(listener);\n  }\n\n  /**\n   * ç§»é™¤ç›´æ’­äº‹ä»¶ç›£è½å™¨\n   */\n  offStreamEvent(streamId: string, listener: (event: any) => void): void {\n    const listeners = this.streamListeners.get(streamId);\n    if (!listeners) return;\n\n    const index = listeners.indexOf(listener);\n    if (index !== -1) {\n      listeners.splice(index, 1);\n    }\n  }\n\n  /**\n   * é€šçŸ¥ç›´æ’­äº‹ä»¶\n   */\n  private notifyStreamEvent(streamId: string, event: any): void {\n    const listeners = this.streamListeners.get(streamId) || [];\n    for (const listener of listeners) {\n      try {\n        listener(event);\n      } catch (error) {\n        console.error('[Live Stream Service] Error in stream listener:', error);\n      }\n    }\n  }\n\n  /**\n   * ç²å–çµ±è¨ˆä¿¡æ¯\n   */\n  getStats() {\n    const liveStreams = Array.from(this.streams.values()).filter((s) => s.status === StreamStatus.LIVE);\n    const totalViewers = Array.from(this.streamViewers.values()).reduce((sum, viewers) => sum + viewers.size, 0);\n    const totalGiftRevenue = Array.from(this.giftRecords.values()).reduce(\n      (sum, record) => sum.plus(record.totalPrice),\n      new Decimal('0')\n    );\n\n    return {\n      liveStreamCount: liveStreams.length,\n      totalViewers,\n      totalGiftRevenue: totalGiftRevenue.toString(),\n      totalMessages: Array.from(this.chatMessages.values()).reduce((sum, msgs) => sum + msgs.length, 0),\n    };\n  }\n}\n\n// å°å‡ºå–®ä¾‹\nexport const liveStreamService = new LiveStreamService();\n
