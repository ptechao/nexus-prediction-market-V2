/**\n * Market Event Monitor 服務\n * \n * 監控市場狀態變化、市場結束事件、市場解決事件、市場異常事件\n */\n\n/**\n * 市場事件類型\n */\nexport enum MarketEventType {\n  CREATED = 'created',\n  OPENED = 'opened',\n  CLOSED = 'closed',\n  RESOLVED = 'resolved',\n  CANCELLED = 'cancelled',\n  PRICE_UPDATED = 'price_updated',\n  LIQUIDITY_ADDED = 'liquidity_added',\n  LIQUIDITY_REMOVED = 'liquidity_removed',\n  ANOMALY_DETECTED = 'anomaly_detected',\n  ORACLE_FAILURE = 'oracle_failure',\n}\n\n/**\n * 市場事件\n */\nexport interface MarketEvent {\n  id: string;\n  marketId: string;\n  type: MarketEventType;\n  timestamp: number;\n  data: Record<string, any>;\n  severity: 'info' | 'warning' | 'critical';\n  processed: boolean;\n}\n\n/**\n * 市場狀態\n */\ninterface MarketState {\n  marketId: string;\n  status: 'active' | 'closed' | 'resolved' | 'cancelled';\n  lastUpdate: number;\n  lastPrice?: number;\n  lastLiquidity?: bigint;\n  eventCount: number;\n}\n\n/**\n * 異常檢測配置\n */\ninterface AnomalyConfig {\n  priceChangeThreshold: number; // %\n  liquidityChangeThreshold: number; // %\n  volumeSpike Threshold: number; // %\n  timeGapThreshold: number; // 毫秒\n}\n\n/**\n * Market Event Monitor 服務\n */\nclass MarketEventMonitor {\n  private events: Map<string, MarketEvent[]> = new Map();\n  private marketStates: Map<string, MarketState> = new Map();\n  private eventListeners: ((event: MarketEvent) => void)[] = [];\n  private anomalyConfig: AnomalyConfig = {\n    priceChangeThreshold: 10, // 10% 價格變化\n    liquidityChangeThreshold: 20, // 20% 流動性變化\n    volumeSpikeThreshold: 50, // 50% 交易量突增\n    timeGapThreshold: 5 * 60 * 1000, // 5 分鐘\n  };\n  private maxEventsPerMarket: number = 1000;\n\n  /**\n   * 記錄市場事件\n   */\n  recordEvent(\n    marketId: string,\n    type: MarketEventType,\n    data: Record<string, any>,\n    severity: 'info' | 'warning' | 'critical' = 'info'\n  ): string {\n    const eventId = `${marketId}-${type}-${Date.now()}`;\n\n    const event: MarketEvent = {\n      id: eventId,\n      marketId,\n      type,\n      timestamp: Date.now(),\n      data,\n      severity,\n      processed: false,\n    };\n\n    // 保存事件\n    if (!this.events.has(marketId)) {\n      this.events.set(marketId, []);\n    }\n    const marketEvents = this.events.get(marketId)!;\n    marketEvents.push(event);\n\n    // 保持最大事件數\n    if (marketEvents.length > this.maxEventsPerMarket) {\n      marketEvents.shift();\n    }\n\n    // 更新市場狀態\n    this.updateMarketState(marketId, type, data);\n\n    // 通知監聽器\n    this.notifyListeners(event);\n\n    return eventId;\n  }\n\n  /**\n   * 更新市場狀態\n   */\n  private updateMarketState(marketId: string, type: MarketEventType, data: Record<string, any>): void {\n    if (!this.marketStates.has(marketId)) {\n      this.marketStates.set(marketId, {\n        marketId,\n        status: 'active',\n        lastUpdate: Date.now(),\n        eventCount: 0,\n      });\n    }\n\n    const state = this.marketStates.get(marketId)!;\n    state.lastUpdate = Date.now();\n    state.eventCount++;\n\n    // 更新狀態\n    switch (type) {\n      case MarketEventType.OPENED:\n        state.status = 'active';\n        break;\n      case MarketEventType.CLOSED:\n        state.status = 'closed';\n        break;\n      case MarketEventType.RESOLVED:\n        state.status = 'resolved';\n        break;\n      case MarketEventType.CANCELLED:\n        state.status = 'cancelled';\n        break;\n    }\n\n    // 更新價格和流動性\n    if (data.price !== undefined) {\n      state.lastPrice = data.price;\n    }\n    if (data.liquidity !== undefined) {\n      state.lastLiquidity = data.liquidity;\n    }\n  }\n\n  /**\n   * 檢測異常\n   */\n  detectAnomalies(\n    marketId: string,\n    currentPrice: number,\n    currentLiquidity: bigint,\n    currentVolume: bigint\n  ): MarketEvent[] {\n    const anomalies: MarketEvent[] = [];\n    const state = this.marketStates.get(marketId);\n\n    if (!state) return anomalies;\n\n    // 檢測價格異常\n    if (state.lastPrice !== undefined) {\n      const priceChange = Math.abs((currentPrice - state.lastPrice) / state.lastPrice) * 100;\n      if (priceChange > this.anomalyConfig.priceChangeThreshold) {\n        const eventId = this.recordEvent(\n          marketId,\n          MarketEventType.ANOMALY_DETECTED,\n          {\n            type: 'price_spike',\n            previousPrice: state.lastPrice,\n            currentPrice,\n            changePercent: priceChange,\n          },\n          'warning'\n        );\n        anomalies.push(this.events.get(marketId)!.find((e) => e.id === eventId)!);\n      }\n    }\n\n    // 檢測流動性異常\n    if (state.lastLiquidity !== undefined) {\n      const liquidityChange =\n        Math.abs(Number(currentLiquidity - state.lastLiquidity) / Number(state.lastLiquidity)) * 100;\n      if (liquidityChange > this.anomalyConfig.liquidityChangeThreshold) {\n        const eventId = this.recordEvent(\n          marketId,\n          MarketEventType.ANOMALY_DETECTED,\n          {\n            type: 'liquidity_spike',\n            previousLiquidity: state.lastLiquidity.toString(),\n            currentLiquidity: currentLiquidity.toString(),\n            changePercent: liquidityChange,\n          },\n          'warning'\n        );\n        anomalies.push(this.events.get(marketId)!.find((e) => e.id === eventId)!);\n      }\n    }\n\n    // 檢測時間間隔異常\n    const timeSinceLastUpdate = Date.now() - state.lastUpdate;\n    if (timeSinceLastUpdate > this.anomalyConfig.timeGapThreshold) {\n      const eventId = this.recordEvent(\n        marketId,\n        MarketEventType.ANOMALY_DETECTED,\n        {\n          type: 'time_gap',\n          timeSinceLastUpdate,\n          threshold: this.anomalyConfig.timeGapThreshold,\n        },\n        'warning'\n      );\n      anomalies.push(this.events.get(marketId)!.find((e) => e.id === eventId)!);\n    }\n\n    return anomalies;\n  }\n\n  /**\n   * 記錄 Oracle 失敗\n   */\n  recordOracleFailure(marketId: string, oracleAddress: string, error: string): string {\n    return this.recordEvent(\n      marketId,\n      MarketEventType.ORACLE_FAILURE,\n      {\n        oracleAddress,\n        error,\n        timestamp: Date.now(),\n      },\n      'critical'\n    );\n  }\n\n  /**\n   * 獲取市場事件\n   */\n  getMarketEvents(marketId: string, limit?: number): MarketEvent[] {\n    const events = this.events.get(marketId) || [];\n    if (!limit) return events;\n    return events.slice(-limit);\n  }\n\n  /**\n   * 獲取特定類型的事件\n   */\n  getEventsByType(marketId: string, type: MarketEventType): MarketEvent[] {\n    const events = this.events.get(marketId) || [];\n    return events.filter((e) => e.type === type);\n  }\n\n  /**\n   * 獲取特定時間範圍的事件\n   */\n  getEventsByTimeRange(marketId: string, startTime: number, endTime: number): MarketEvent[] {\n    const events = this.events.get(marketId) || [];\n    return events.filter((e) => e.timestamp >= startTime && e.timestamp <= endTime);\n  }\n\n  /**\n   * 獲取市場狀態\n   */\n  getMarketState(marketId: string): MarketState | null {\n    return this.marketStates.get(marketId) || null;\n  }\n\n  /**\n   * 獲取所有市場狀態\n   */\n  getAllMarketStates(): MarketState[] {\n    return Array.from(this.marketStates.values());\n  }\n\n  /**\n   * 標記事件為已處理\n   */\n  markEventProcessed(marketId: string, eventId: string): boolean {\n    const events = this.events.get(marketId);\n    if (!events) return false;\n\n    const event = events.find((e) => e.id === eventId);\n    if (!event) return false;\n\n    event.processed = true;\n    return true;\n  }\n\n  /**\n   * 獲取未處理的事件\n   */\n  getUnprocessedEvents(): MarketEvent[] {\n    const unprocessed: MarketEvent[] = [];\n    for (const events of this.events.values()) {\n      for (const event of events) {\n        if (!event.processed) {\n          unprocessed.push(event);\n        }\n      }\n    }\n    return unprocessed;\n  }\n\n  /**\n   * 註冊事件監聽器\n   */\n  onEvent(listener: (event: MarketEvent) => void): void {\n    this.eventListeners.push(listener);\n  }\n\n  /**\n   * 移除事件監聽器\n   */\n  offEvent(listener: (event: MarketEvent) => void): void {\n    const index = this.eventListeners.indexOf(listener);\n    if (index !== -1) {\n      this.eventListeners.splice(index, 1);\n    }\n  }\n\n  /**\n   * 通知監聽器\n   */\n  private notifyListeners(event: MarketEvent): void {\n    for (const listener of this.eventListeners) {\n      try {\n        listener(event);\n      } catch (error) {\n        console.error('[Market Event Monitor] Error in listener:', error);\n      }\n    }\n  }\n\n  /**\n   * 設置異常檢測配置\n   */\n  setAnomalyConfig(config: Partial<AnomalyConfig>): void {\n    this.anomalyConfig = { ...this.anomalyConfig, ...config };\n  }\n\n  /**\n   * 獲取異常檢測配置\n   */\n  getAnomalyConfig(): AnomalyConfig {\n    return { ...this.anomalyConfig };\n  }\n\n  /**\n   * 獲取統計信息\n   */\n  getStats() {\n    return {\n      markets: this.marketStates.size,\n      totalEvents: Array.from(this.events.values()).reduce((sum, events) => sum + events.length, 0),\n      unprocessedEvents: this.getUnprocessedEvents().length,\n      criticalEvents: Array.from(this.events.values()).reduce(\n        (sum, events) => sum + events.filter((e) => e.severity === 'critical').length,\n        0\n      ),\n    };\n  }\n\n  /**\n   * 清理舊事件\n   */\n  cleanupOldEvents(maxAge: number = 7 * 24 * 60 * 60 * 1000): void {\n    const now = Date.now();\n    for (const [marketId, events] of this.events) {\n      const filtered = events.filter((e) => now - e.timestamp < maxAge);\n      if (filtered.length === 0) {\n        this.events.delete(marketId);\n      } else {\n        this.events.set(marketId, filtered);\n      }\n    }\n  }\n}\n\n// 導出單例\nconst marketEventMonitor = new MarketEventMonitor();\n\nexport default marketEventMonitor;\nexport type { MarketEvent, MarketState, AnomalyConfig };\n
