/**\n * Vault Manager 服務\n * \n * Vault 管理、資金管理、績效追蹤、費用計算\n */\n\nimport Decimal from 'decimal.js';\n\n/**\n * Vault 狀態\n */\nexport enum VaultStatus {\n  ACTIVE = 'active',\n  PAUSED = 'paused',\n  CLOSED = 'closed',\n}\n\n/**\n * Vault 信息\n */\nexport interface Vault {\n  id: string;\n  managerId: string;\n  name: string;\n  description: string;\n  status: VaultStatus;\n  totalAssets: Decimal; // 總資產\n  totalShares: Decimal; // 總份額\n  navPerShare: Decimal; // 每份額淨值\n  performanceFee: Decimal; // 績效費（%）\n  managementFee: Decimal; // 管理費（%）\n  minInvestment: Decimal; // 最小投資額\n  maxInvestment: Decimal; // 最大投資額\n  createdAt: number;\n  updatedAt: number;\n}\n\n/**\n * Vault 份額\n */\nexport interface VaultShare {\n  id: string;\n  vaultId: string;\n  investorId: string;\n  shares: Decimal; // 持有份額\n  investmentAmount: Decimal; // 投資金額\n  currentValue: Decimal; // 當前價值\n  unrealizedPnL: Decimal; // 未實現損益\n  realizedPnL: Decimal; // 已實現損益\n  createdAt: number;\n  updatedAt: number;\n}\n\n/**\n * Vault 績效\n */\nexport interface VaultPerformance {\n  vaultId: string;\n  period: 'day' | 'week' | 'month' | 'year' | 'all';\n  startValue: Decimal;\n  endValue: Decimal;\n  return: Decimal; // 收益\n  returnPercent: Decimal; // 收益率\n  maxDrawdown: Decimal; // 最大回撤\n  sharpeRatio: Decimal; // 夏普比率\n  winRate: Decimal; // 勝率\n  totalTrades: number;\n  profitableTrades: number;\n  timestamp: number;\n}\n\n/**\n * Vault 費用\n */\nexport interface VaultFee {\n  id: string;\n  vaultId: string;\n  type: 'performance' | 'management';\n  amount: Decimal;\n  rate: Decimal;\n  period: string;\n  chargedAt: number;\n}\n\n/**\n * Vault Manager 服務\n */\nexport class VaultManager {\n  private vaults: Map<string, Vault> = new Map();\n  private shares: Map<string, VaultShare[]> = new Map();\n  private performances: Map<string, VaultPerformance[]> = new Map();\n  private fees: Map<string, VaultFee[]> = new Map();\n  private vaultListeners: ((vault: Vault) => void)[] = [];\n  private performanceListeners: ((perf: VaultPerformance) => void)[] = [];\n\n  /**\n   * 創建 Vault\n   */\n  createVault(\n    managerId: string,\n    name: string,\n    description: string,\n    performanceFee: Decimal,\n    managementFee: Decimal,\n    minInvestment: Decimal,\n    maxInvestment: Decimal\n  ): { vaultId: string; error?: string } {\n    // 驗證參數\n    if (performanceFee.lessThan(0) || performanceFee.greaterThan(50)) {\n      return { vaultId: '', error: 'Performance fee must be between 0 and 50' };\n    }\n    if (managementFee.lessThan(0) || managementFee.greaterThan(5)) {\n      return { vaultId: '', error: 'Management fee must be between 0 and 5' };\n    }\n    if (minInvestment.greaterThan(maxInvestment)) {\n      return { vaultId: '', error: 'Min investment must be less than max investment' };\n    }\n\n    const vaultId = `vault-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n    const vault: Vault = {\n      id: vaultId,\n      managerId,\n      name,\n      description,\n      status: VaultStatus.ACTIVE,\n      totalAssets: new Decimal('0'),\n      totalShares: new Decimal('0'),\n      navPerShare: new Decimal('1'), // 初始每份額淨值為 1\n      performanceFee,\n      managementFee,\n      minInvestment,\n      maxInvestment,\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n    };\n\n    this.vaults.set(vaultId, vault);\n    this.shares.set(vaultId, []);\n    this.performances.set(vaultId, []);\n    this.fees.set(vaultId, []);\n\n    this.notifyVaultListeners(vault);\n\n    return { vaultId };\n  }\n\n  /**\n   * 投資 Vault\n   */\n  invest(vaultId: string, investorId: string, amount: Decimal): { shareId: string; shares: Decimal; error?: string } {\n    const vault = this.vaults.get(vaultId);\n    if (!vault) {\n      return { shareId: '', shares: new Decimal('0'), error: 'Vault not found' };\n    }\n\n    if (vault.status !== VaultStatus.ACTIVE) {\n      return { shareId: '', shares: new Decimal('0'), error: 'Vault is not active' };\n    }\n\n    if (amount.lessThan(vault.minInvestment)) {\n      return { shareId: '', shares: new Decimal('0'), error: `Minimum investment is ${vault.minInvestment}` };\n    }\n\n    if (amount.greaterThan(vault.maxInvestment)) {\n      return { shareId: '', shares: new Decimal('0'), error: `Maximum investment is ${vault.maxInvestment}` };\n    }\n\n    // 計算份額\n    const shares = vault.navPerShare.equals(0) ? amount : amount.dividedBy(vault.navPerShare);\n\n    // 創建份額記錄\n    const shareId = `share-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n    const share: VaultShare = {\n      id: shareId,\n      vaultId,\n      investorId,\n      shares,\n      investmentAmount: amount,\n      currentValue: amount,\n      unrealizedPnL: new Decimal('0'),\n      realizedPnL: new Decimal('0'),\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n    };\n\n    const vaultShares = this.shares.get(vaultId) || [];\n    vaultShares.push(share);\n    this.shares.set(vaultId, vaultShares);\n\n    // 更新 Vault\n    vault.totalAssets = vault.totalAssets.plus(amount);\n    vault.totalShares = vault.totalShares.plus(shares);\n    vault.updatedAt = Date.now();\n\n    this.notifyVaultListeners(vault);\n\n    return { shareId, shares };\n  }\n\n  /**\n   * 贖回 Vault\n   */\n  redeem(shareId: string, shares: Decimal): { redeemAmount: Decimal; error?: string } {\n    // 查找份額\n    let vaultShare: VaultShare | null = null;\n    let vaultId: string | null = null;\n\n    for (const [vid, vaultShares] of this.shares) {\n      const found = vaultShares.find((s) => s.id === shareId);\n      if (found) {\n        vaultShare = found;\n        vaultId = vid;\n        break;\n      }\n    }\n\n    if (!vaultShare || !vaultId) {\n      return { redeemAmount: new Decimal('0'), error: 'Share not found' };\n    }\n\n    if (shares.greaterThan(vaultShare.shares)) {\n      return { redeemAmount: new Decimal('0'), error: 'Insufficient shares' };\n    }\n\n    const vault = this.vaults.get(vaultId);\n    if (!vault) {\n      return { redeemAmount: new Decimal('0'), error: 'Vault not found' };\n    }\n\n    // 計算贖回金額\n    const redeemAmount = shares.times(vault.navPerShare);\n\n    // 更新份額\n    vaultShare.shares = vaultShare.shares.minus(shares);\n    vaultShare.currentValue = vaultShare.shares.times(vault.navPerShare);\n    vaultShare.updatedAt = Date.now();\n\n    // 更新 Vault\n    vault.totalAssets = vault.totalAssets.minus(redeemAmount);\n    vault.totalShares = vault.totalShares.minus(shares);\n    vault.updatedAt = Date.now();\n\n    this.notifyVaultListeners(vault);\n\n    return { redeemAmount };\n  }\n\n  /**\n   * 更新 Vault 績效\n   */\n  updatePerformance(vaultId: string, newAssets: Decimal): void {\n    const vault = this.vaults.get(vaultId);\n    if (!vault) return;\n\n    const oldAssets = vault.totalAssets;\n    const return_ = newAssets.minus(oldAssets);\n    const returnPercent = oldAssets.equals(0) ? new Decimal('0') : return_.dividedBy(oldAssets).times(100);\n\n    // 更新 NAV\n    vault.navPerShare = vault.totalShares.equals(0) ? new Decimal('1') : newAssets.dividedBy(vault.totalShares);\n    vault.totalAssets = newAssets;\n    vault.updatedAt = Date.now();\n\n    // 創建績效記錄\n    const performance: VaultPerformance = {\n      vaultId,\n      period: 'day',\n      startValue: oldAssets,\n      endValue: newAssets,\n      return: return_,\n      returnPercent,\n      maxDrawdown: new Decimal('0'), // TODO: 計算最大回撤\n      sharpeRatio: new Decimal('0'), // TODO: 計算夏普比率\n      winRate: new Decimal('0'), // TODO: 計算勝率\n      totalTrades: 0, // TODO: 從交易記錄獲取\n      profitableTrades: 0, // TODO: 從交易記錄獲取\n      timestamp: Date.now(),\n    };\n\n    const performances = this.performances.get(vaultId) || [];\n    performances.push(performance);\n    if (performances.length > 365) {\n      performances.shift();\n    }\n    this.performances.set(vaultId, performances);\n\n    this.notifyPerformanceListeners(performance);\n    this.notifyVaultListeners(vault);\n  }\n\n  /**\n   * 收取績效費\n   */\n  chargePerformanceFee(vaultId: string): { feeAmount: Decimal; error?: string } {\n    const vault = this.vaults.get(vaultId);\n    if (!vault) {\n      return { feeAmount: new Decimal('0'), error: 'Vault not found' };\n    }\n\n    const performances = this.performances.get(vaultId) || [];\n    if (performances.length === 0) {\n      return { feeAmount: new Decimal('0'), error: 'No performance data' };\n    }\n\n    // 計算本年度收益\n    const yearStart = Date.now() - 365 * 24 * 60 * 60 * 1000;\n    const yearPerformances = performances.filter((p) => p.timestamp >= yearStart);\n    const totalReturn = yearPerformances.reduce((sum, p) => sum.plus(p.return), new Decimal('0'));\n\n    if (totalReturn.lessThanOrEqualTo(0)) {\n      return { feeAmount: new Decimal('0'), error: 'No positive performance' };\n    }\n\n    // 計算績效費\n    const feeAmount = totalReturn.times(vault.performanceFee).dividedBy(100);\n\n    // 記錄費用\n    const fee: VaultFee = {\n      id: `fee-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n      vaultId,\n      type: 'performance',\n      amount: feeAmount,\n      rate: vault.performanceFee,\n      period: new Date().toISOString().split('T')[0],\n      chargedAt: Date.now(),\n    };\n\n    const fees = this.fees.get(vaultId) || [];\n    fees.push(fee);\n    this.fees.set(vaultId, fees);\n\n    // 從 Vault 資產中扣除\n    vault.totalAssets = vault.totalAssets.minus(feeAmount);\n    vault.navPerShare = vault.totalShares.equals(0) ? new Decimal('1') : vault.totalAssets.dividedBy(vault.totalShares);\n    vault.updatedAt = Date.now();\n\n    this.notifyVaultListeners(vault);\n\n    return { feeAmount };\n  }\n\n  /**\n   * 收取管理費\n   */\n  chargeManagementFee(vaultId: string): { feeAmount: Decimal; error?: string } {\n    const vault = this.vaults.get(vaultId);\n    if (!vault) {\n      return { feeAmount: new Decimal('0'), error: 'Vault not found' };\n    }\n\n    // 計算月度管理費\n    const feeAmount = vault.totalAssets.times(vault.managementFee).dividedBy(100).dividedBy(12);\n\n    if (feeAmount.equals(0)) {\n      return { feeAmount, error: 'Fee amount is zero' };\n    }\n\n    // 記錄費用\n    const fee: VaultFee = {\n      id: `fee-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n      vaultId,\n      type: 'management',\n      amount: feeAmount,\n      rate: vault.managementFee,\n      period: new Date().toISOString().split('T')[0],\n      chargedAt: Date.now(),\n    };\n\n    const fees = this.fees.get(vaultId) || [];\n    fees.push(fee);\n    this.fees.set(vaultId, fees);\n\n    // 從 Vault 資產中扣除\n    vault.totalAssets = vault.totalAssets.minus(feeAmount);\n    vault.navPerShare = vault.totalShares.equals(0) ? new Decimal('1') : vault.totalAssets.dividedBy(vault.totalShares);\n    vault.updatedAt = Date.now();\n\n    this.notifyVaultListeners(vault);\n\n    return { feeAmount };\n  }\n\n  /**\n   * 獲取 Vault\n   */\n  getVault(vaultId: string): Vault | null {\n    return this.vaults.get(vaultId) || null;\n  }\n\n  /**\n   * 獲取管理者的 Vault\n   */\n  getManagerVaults(managerId: string): Vault[] {\n    return Array.from(this.vaults.values()).filter((v) => v.managerId === managerId);\n  }\n\n  /**\n   * 獲取投資者的份額\n   */\n  getInvestorShares(investorId: string): VaultShare[] {\n    return Array.from(this.shares.values())\n      .flat()\n      .filter((s) => s.investorId === investorId);\n  }\n\n  /**\n   * 獲取 Vault 績效\n   */\n  getVaultPerformance(vaultId: string, period?: 'day' | 'week' | 'month' | 'year' | 'all'): VaultPerformance[] {\n    const performances = this.performances.get(vaultId) || [];\n    if (!period) return performances;\n    return performances.filter((p) => p.period === period);\n  }\n\n  /**\n   * 獲取 Vault 費用\n   */\n  getVaultFees(vaultId: string): VaultFee[] {\n    return this.fees.get(vaultId) || [];\n  }\n\n  /**\n   * 暫停 Vault\n   */\n  pauseVault(vaultId: string): boolean {\n    const vault = this.vaults.get(vaultId);\n    if (!vault) return false;\n    vault.status = VaultStatus.PAUSED;\n    vault.updatedAt = Date.now();\n    this.notifyVaultListeners(vault);\n    return true;\n  }\n\n  /**\n   * 恢復 Vault\n   */\n  resumeVault(vaultId: string): boolean {\n    const vault = this.vaults.get(vaultId);\n    if (!vault) return false;\n    vault.status = VaultStatus.ACTIVE;\n    vault.updatedAt = Date.now();\n    this.notifyVaultListeners(vault);\n    return true;\n  }\n\n  /**\n   * 關閉 Vault\n   */\n  closeVault(vaultId: string): boolean {\n    const vault = this.vaults.get(vaultId);\n    if (!vault) return false;\n    vault.status = VaultStatus.CLOSED;\n    vault.updatedAt = Date.now();\n    this.notifyVaultListeners(vault);\n    return true;\n  }\n\n  /**\n   * 註冊 Vault 監聽器\n   */\n  onVaultUpdate(listener: (vault: Vault) => void): void {\n    this.vaultListeners.push(listener);\n  }\n\n  /**\n   * 移除 Vault 監聽器\n   */\n  offVaultUpdate(listener: (vault: Vault) => void): void {\n    const index = this.vaultListeners.indexOf(listener);\n    if (index !== -1) {\n      this.vaultListeners.splice(index, 1);\n    }\n  }\n\n  /**\n   * 通知 Vault 監聽器\n   */\n  private notifyVaultListeners(vault: Vault): void {\n    for (const listener of this.vaultListeners) {\n      try {\n        listener(vault);\n      } catch (error) {\n        console.error('[Vault Manager] Error in vault listener:', error);\n      }\n    }\n  }\n\n  /**\n   * 註冊績效監聽器\n   */\n  onPerformanceUpdate(listener: (perf: VaultPerformance) => void): void {\n    this.performanceListeners.push(listener);\n  }\n\n  /**\n   * 移除績效監聽器\n   */\n  offPerformanceUpdate(listener: (perf: VaultPerformance) => void): void {\n    const index = this.performanceListeners.indexOf(listener);\n    if (index !== -1) {\n      this.performanceListeners.splice(index, 1);\n    }\n  }\n\n  /**\n   * 通知績效監聽器\n   */\n  private notifyPerformanceListeners(perf: VaultPerformance): void {\n    for (const listener of this.performanceListeners) {\n      try {\n        listener(perf);\n      } catch (error) {\n        console.error('[Vault Manager] Error in performance listener:', error);\n      }\n    }\n  }\n\n  /**\n   * 獲取統計信息\n   */\n  getStats() {\n    const totalAssets = Array.from(this.vaults.values()).reduce((sum, v) => sum.plus(v.totalAssets), new Decimal('0'));\n    const totalShares = Array.from(this.vaults.values()).reduce((sum, v) => sum.plus(v.totalShares), new Decimal('0'));\n    const totalInvestors = new Set(\n      Array.from(this.shares.values())\n        .flat()\n        .map((s) => s.investorId)\n    ).size;\n\n    return {\n      vaults: this.vaults.size,\n      totalAssets: totalAssets.toString(),\n      totalShares: totalShares.toString(),\n      investors: totalInvestors,\n    };\n  }\n}\n\n// 導出單例\nexport const vaultManager = new VaultManager();\n
