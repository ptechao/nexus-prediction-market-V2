/**\n * Auth Service\n * \n * 用戶認證、授權、會話管理、權限控制\n */\n\nimport Decimal from 'decimal.js';\nimport crypto from 'crypto';\n\n/**\n * 用戶角色\n */\nexport enum UserRole {\n  ADMIN = 'admin',\n  TRADER = 'trader',\n  MANAGER = 'manager',\n  MODERATOR = 'moderator',\n  USER = 'user',\n}\n\n/**\n * 用戶狀態\n */\nexport enum UserStatus {\n  ACTIVE = 'active',\n  INACTIVE = 'inactive',\n  SUSPENDED = 'suspended',\n  BANNED = 'banned',\n}\n\n/**\n * 用戶信息\n */\nexport interface User {\n  id: string;\n  username: string;\n  email: string;\n  passwordHash: string;\n  role: UserRole;\n  status: UserStatus;\n  profile: {\n    displayName: string;\n    avatar?: string;\n    bio?: string;\n    location?: string;\n    website?: string;\n  };\n  accountValue: Decimal;\n  totalTrades: number;\n  winRate: Decimal;\n  followers: number;\n  following: number;\n  verified: boolean;\n  twoFactorEnabled: boolean;\n  createdAt: number;\n  updatedAt: number;\n  lastLoginAt?: number;\n}\n\n/**\n * 會話信息\n */\nexport interface Session {\n  id: string;\n  userId: string;\n  token: string;\n  refreshToken: string;\n  expiresAt: number;\n  createdAt: number;\n  ipAddress?: string;\n  userAgent?: string;\n  isActive: boolean;\n}\n\n/**\n * 權限定義\n */\nexport interface Permission {\n  id: string;\n  name: string;\n  description: string;\n  resource: string;\n  action: string;\n}\n\n/**\n * 角色權限映射\n */\nexport interface RolePermission {\n  role: UserRole;\n  permissions: Permission[];\n}\n\n/**\n * Auth Service\n */\nexport class AuthService {\n  private users: Map<string, User> = new Map();\n  private sessions: Map<string, Session> = new Map();\n  private permissions: Map<string, Permission> = new Map();\n  private rolePermissions: Map<UserRole, Permission[]> = new Map();\n  private passwordSaltRounds: number = 10;\n  private sessionTimeout: number = 24 * 60 * 60 * 1000; // 24 小時\n  private authListeners: ((user: User) => void)[] = [];\n\n  constructor() {\n    this.initializePermissions();\n    this.initializeRolePermissions();\n  }\n\n  /**\n   * 初始化權限\n   */\n  private initializePermissions(): void {\n    const permissions: Permission[] = [\n      // 市場權限\n      { id: 'market-view', name: 'View Markets', description: '查看市場', resource: 'market', action: 'view' },\n      { id: 'market-create', name: 'Create Market', description: '創建市場', resource: 'market', action: 'create' },\n      { id: 'market-edit', name: 'Edit Market', description: '編輯市場', resource: 'market', action: 'edit' },\n      { id: 'market-delete', name: 'Delete Market', description: '刪除市場', resource: 'market', action: 'delete' },\n\n      // 交易權限\n      { id: 'trade-view', name: 'View Trades', description: '查看交易', resource: 'trade', action: 'view' },\n      { id: 'trade-create', name: 'Create Trade', description: '創建交易', resource: 'trade', action: 'create' },\n      { id: 'trade-cancel', name: 'Cancel Trade', description: '取消交易', resource: 'trade', action: 'cancel' },\n\n      // Vault 權限\n      { id: 'vault-view', name: 'View Vaults', description: '查看 Vault', resource: 'vault', action: 'view' },\n      { id: 'vault-create', name: 'Create Vault', description: '創建 Vault', resource: 'vault', action: 'create' },\n      { id: 'vault-manage', name: 'Manage Vault', description: '管理 Vault', resource: 'vault', action: 'manage' },\n\n      // 用戶管理權限\n      { id: 'user-view', name: 'View Users', description: '查看用戶', resource: 'user', action: 'view' },\n      { id: 'user-manage', name: 'Manage Users', description: '管理用戶', resource: 'user', action: 'manage' },\n      { id: 'user-ban', name: 'Ban Users', description: '封禁用戶', resource: 'user', action: 'ban' },\n\n      // 系統管理權限\n      { id: 'system-view', name: 'View System', description: '查看系統', resource: 'system', action: 'view' },\n      { id: 'system-manage', name: 'Manage System', description: '管理系統', resource: 'system', action: 'manage' },\n    ];\n\n    for (const perm of permissions) {\n      this.permissions.set(perm.id, perm);\n    }\n  }\n\n  /**\n   * 初始化角色權限映射\n   */\n  private initializeRolePermissions(): void {\n    // Admin - 所有權限\n    this.rolePermissions.set(UserRole.ADMIN, Array.from(this.permissions.values()));\n\n    // Manager - Vault 和用戶管理\n    this.rolePermissions.set(UserRole.MANAGER, [\n      this.permissions.get('market-view')!,\n      this.permissions.get('trade-view')!,\n      this.permissions.get('vault-view')!,\n      this.permissions.get('vault-create')!,\n      this.permissions.get('vault-manage')!,\n      this.permissions.get('user-view')!,\n    ]);\n\n    // Trader - 交易和市場查看\n    this.rolePermissions.set(UserRole.TRADER, [\n      this.permissions.get('market-view')!,\n      this.permissions.get('trade-view')!,\n      this.permissions.get('trade-create')!,\n      this.permissions.get('trade-cancel')!,\n      this.permissions.get('vault-view')!,\n    ]);\n\n    // Moderator - 市場和用戶管理\n    this.rolePermissions.set(UserRole.MODERATOR, [\n      this.permissions.get('market-view')!,\n      this.permissions.get('market-edit')!,\n      this.permissions.get('user-view')!,\n      this.permissions.get('user-manage')!,\n    ]);\n\n    // User - 基本權限\n    this.rolePermissions.set(UserRole.USER, [\n      this.permissions.get('market-view')!,\n      this.permissions.get('trade-view')!,\n      this.permissions.get('vault-view')!,\n    ]);\n  }\n\n  /**\n   * 註冊用戶\n   */\n  register(\n    username: string,\n    email: string,\n    password: string,\n    displayName: string\n  ): { userId: string; error?: string } {\n    // 驗證參數\n    if (!username || username.length < 3) {\n      return { userId: '', error: 'Username must be at least 3 characters' };\n    }\n    if (!email || !this.isValidEmail(email)) {\n      return { userId: '', error: 'Invalid email' };\n    }\n    if (!password || password.length < 8) {\n      return { userId: '', error: 'Password must be at least 8 characters' };\n    }\n\n    // 檢查用戶是否已存在\n    const existing = Array.from(this.users.values()).find(\n      (u) => u.username === username || u.email === email\n    );\n    if (existing) {\n      return { userId: '', error: 'Username or email already exists' };\n    }\n\n    // 創建用戶\n    const userId = `user-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n    const passwordHash = this.hashPassword(password);\n\n    const user: User = {\n      id: userId,\n      username,\n      email,\n      passwordHash,\n      role: UserRole.USER,\n      status: UserStatus.ACTIVE,\n      profile: {\n        displayName,\n      },\n      accountValue: new Decimal('0'),\n      totalTrades: 0,\n      winRate: new Decimal('0'),\n      followers: 0,\n      following: 0,\n      verified: false,\n      twoFactorEnabled: false,\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n    };\n\n    this.users.set(userId, user);\n    this.notifyAuthListeners(user);\n\n    return { userId };\n  }\n\n  /**\n   * 登錄\n   */\n  login(email: string, password: string, ipAddress?: string, userAgent?: string): { sessionId: string; token: string; error?: string } {\n    // 查找用戶\n    const user = Array.from(this.users.values()).find((u) => u.email === email);\n    if (!user) {\n      return { sessionId: '', token: '', error: 'Invalid email or password' };\n    }\n\n    // 檢查用戶狀態\n    if (user.status !== UserStatus.ACTIVE) {\n      return { sessionId: '', token: '', error: 'User account is not active' };\n    }\n\n    // 驗證密碼\n    if (!this.verifyPassword(password, user.passwordHash)) {\n      return { sessionId: '', token: '', error: 'Invalid email or password' };\n    }\n\n    // 創建會話\n    const sessionId = `session-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n    const token = this.generateToken();\n    const refreshToken = this.generateToken();\n\n    const session: Session = {\n      id: sessionId,\n      userId: user.id,\n      token,\n      refreshToken,\n      expiresAt: Date.now() + this.sessionTimeout,\n      createdAt: Date.now(),\n      ipAddress,\n      userAgent,\n      isActive: true,\n    };\n\n    this.sessions.set(sessionId, session);\n\n    // 更新最後登錄時間\n    user.lastLoginAt = Date.now();\n    user.updatedAt = Date.now();\n\n    this.notifyAuthListeners(user);\n\n    return { sessionId, token };\n  }\n\n  /**\n   * 登出\n   */\n  logout(sessionId: string): boolean {\n    const session = this.sessions.get(sessionId);\n    if (!session) return false;\n\n    session.isActive = false;\n    return true;\n  }\n\n  /**\n   * 刷新令牌\n   */\n  refreshToken(sessionId: string): { token: string; error?: string } {\n    const session = this.sessions.get(sessionId);\n    if (!session || !session.isActive) {\n      return { token: '', error: 'Invalid session' };\n    }\n\n    if (Date.now() > session.expiresAt) {\n      return { token: '', error: 'Session expired' };\n    }\n\n    const newToken = this.generateToken();\n    session.token = newToken;\n    session.expiresAt = Date.now() + this.sessionTimeout;\n\n    return { token: newToken };\n  }\n\n  /**\n   * 驗證令牌\n   */\n  verifyToken(token: string): { userId: string; error?: string } {\n    const session = Array.from(this.sessions.values()).find(\n      (s) => s.token === token && s.isActive && Date.now() <= s.expiresAt\n    );\n\n    if (!session) {\n      return { userId: '', error: 'Invalid or expired token' };\n    }\n\n    return { userId: session.userId };\n  }\n\n  /**\n   * 檢查權限\n   */\n  hasPermission(userId: string, resource: string, action: string): boolean {\n    const user = this.users.get(userId);\n    if (!user) return false;\n\n    const permissions = this.rolePermissions.get(user.role) || [];\n    return permissions.some((p) => p.resource === resource && p.action === action);\n  }\n\n  /**\n   * 檢查角色\n   */\n  hasRole(userId: string, role: UserRole): boolean {\n    const user = this.users.get(userId);\n    if (!user) return false;\n    return user.role === role;\n  }\n\n  /**\n   * 更新用戶角色\n   */\n  updateUserRole(userId: string, newRole: UserRole): boolean {\n    const user = this.users.get(userId);\n    if (!user) return false;\n\n    user.role = newRole;\n    user.updatedAt = Date.now();\n    this.notifyAuthListeners(user);\n\n    return true;\n  }\n\n  /**\n   * 更新用戶狀態\n   */\n  updateUserStatus(userId: string, newStatus: UserStatus): boolean {\n    const user = this.users.get(userId);\n    if (!user) return false;\n\n    user.status = newStatus;\n    user.updatedAt = Date.now();\n\n    // 如果禁用用戶，註銷所有會話\n    if (newStatus !== UserStatus.ACTIVE) {\n      for (const session of this.sessions.values()) {\n        if (session.userId === userId) {\n          session.isActive = false;\n        }\n      }\n    }\n\n    this.notifyAuthListeners(user);\n    return true;\n  }\n\n  /**\n   * 獲取用戶\n   */\n  getUser(userId: string): User | null {\n    return this.users.get(userId) || null;\n  }\n\n  /**\n   * 獲取用戶（通過用戶名）\n   */\n  getUserByUsername(username: string): User | null {\n    return Array.from(this.users.values()).find((u) => u.username === username) || null;\n  }\n\n  /**\n   * 獲取用戶（通過郵箱）\n   */\n  getUserByEmail(email: string): User | null {\n    return Array.from(this.users.values()).find((u) => u.email === email) || null;\n  }\n\n  /**\n   * 獲取會話\n   */\n  getSession(sessionId: string): Session | null {\n    return this.sessions.get(sessionId) || null;\n  }\n\n  /**\n   * 獲取用戶的會話\n   */\n  getUserSessions(userId: string): Session[] {\n    return Array.from(this.sessions.values()).filter(\n      (s) => s.userId === userId && s.isActive && Date.now() <= s.expiresAt\n    );\n  }\n\n  /**\n   * 獲取權限\n   */\n  getPermissions(userId: string): Permission[] {\n    const user = this.users.get(userId);\n    if (!user) return [];\n    return this.rolePermissions.get(user.role) || [];\n  }\n\n  /**\n   * 更新用戶資料\n   */\n  updateUserProfile(userId: string, profile: Partial<User['profile']>): boolean {\n    const user = this.users.get(userId);\n    if (!user) return false;\n\n    user.profile = { ...user.profile, ...profile };\n    user.updatedAt = Date.now();\n    this.notifyAuthListeners(user);\n\n    return true;\n  }\n\n  /**\n   * 驗證郵箱\n   */\n  private isValidEmail(email: string): boolean {\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n    return emailRegex.test(email);\n  }\n\n  /**\n   * 密碼哈希\n   */\n  private hashPassword(password: string): string {\n    return crypto.createHash('sha256').update(password).digest('hex');\n  }\n\n  /**\n   * 驗證密碼\n   */\n  private verifyPassword(password: string, hash: string): boolean {\n    return this.hashPassword(password) === hash;\n  }\n\n  /**\n   * 生成令牌\n   */\n  private generateToken(): string {\n    return crypto.randomBytes(32).toString('hex');\n  }\n\n  /**\n   * 註冊認證監聽器\n   */\n  onAuthChange(listener: (user: User) => void): void {\n    this.authListeners.push(listener);\n  }\n\n  /**\n   * 移除認證監聽器\n   */\n  offAuthChange(listener: (user: User) => void): void {\n    const index = this.authListeners.indexOf(listener);\n    if (index !== -1) {\n      this.authListeners.splice(index, 1);\n    }\n  }\n\n  /**\n   * 通知認證監聽器\n   */\n  private notifyAuthListeners(user: User): void {\n    for (const listener of this.authListeners) {\n      try {\n        listener(user);\n      } catch (error) {\n        console.error('[Auth Service] Error in auth listener:', error);\n      }\n    }\n  }\n\n  /**\n   * 獲取統計信息\n   */\n  getStats() {\n    const activeSessions = Array.from(this.sessions.values()).filter(\n      (s) => s.isActive && Date.now() <= s.expiresAt\n    ).length;\n\n    const roleDistribution = new Map<UserRole, number>();\n    for (const user of this.users.values()) {\n      roleDistribution.set(user.role, (roleDistribution.get(user.role) || 0) + 1);\n    }\n\n    return {\n      totalUsers: this.users.size,\n      activeSessions,\n      roleDistribution: Object.fromEntries(roleDistribution),\n    };\n  }\n}\n\n// 導出單例\nexport const authService = new AuthService();\n
