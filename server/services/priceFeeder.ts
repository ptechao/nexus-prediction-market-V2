/**\n * Price Feeder 服務\n * \n * 實時價格更新、價格歷史記錄、價格告警、價格統計\n */\n\nimport { ethers } from 'ethers';\nimport oracleAggregator, { AggregationResult } from './oracleAggregator';\n\n/**\n * 價格更新事件\n */\ninterface PriceUpdate {\n  marketId: string;\n  timestamp: number;\n  yesPrice: number; // 0-1\n  noPrice: number; // 0-1\n  confidence: number;\n  sources: number;\n}\n\n/**\n * 價格歷史記錄\n */\ninterface PriceHistory {\n  timestamp: number;\n  yesPrice: number;\n  noPrice: number;\n  volume24h: bigint;\n  trades24h: number;\n}\n\n/**\n * 價格統計\n */\ninterface PriceStats {\n  currentPrice: number;\n  high24h: number;\n  low24h: number;\n  change24h: number;\n  changePercent24h: number;\n  volatility: number;\n  averagePrice: number;\n}\n\n/**\n * 價格告警\n */\ninterface PriceAlert {\n  id: string;\n  marketId: string;\n  type: 'high' | 'low' | 'volatility' | 'confidence';\n  threshold: number;\n  triggered: boolean;\n  triggeredAt?: number;\n}\n\n/**\n * Price Feeder 服務\n */\nclass PriceFeeder {\n  private priceHistory: Map<string, PriceHistory[]> = new Map();\n  private priceAlerts: Map<string, PriceAlert[]> = new Map();\n  private priceStats: Map<string, PriceStats> = new Map();\n  private updateListeners: ((update: PriceUpdate) => void)[] = [];\n  private alertListeners: ((alert: PriceAlert) => void)[] = [];\n  private maxHistorySize: number = 1440; // 24 小時（每分鐘一條記錄）\n  private updateInterval: number = 60000; // 1 分鐘\n  private updateTimer?: NodeJS.Timeout;\n\n  /**\n   * 啟動價格更新\n   */\n  start(): void {\n    if (this.updateTimer) return;\n\n    console.log('[Price Feeder] Starting price updates');\n    this.updateTimer = setInterval(() => this.updateAllPrices(), this.updateInterval);\n  }\n\n  /**\n   * 停止價格更新\n   */\n  stop(): void {\n    if (this.updateTimer) {\n      clearInterval(this.updateTimer);\n      this.updateTimer = undefined;\n      console.log('[Price Feeder] Stopped price updates');\n    }\n  }\n\n  /**\n   * 更新所有市場的價格\n   */\n  private async updateAllPrices(): Promise<void> {\n    try {\n      // 獲取所有市場的價格\n      const marketIds = Array.from(this.priceHistory.keys());\n\n      for (const marketId of marketIds) {\n        await this.updateMarketPrice(marketId);\n      }\n    } catch (error) {\n      console.error('[Price Feeder] Error updating prices:', error);\n    }\n  }\n\n  /**\n   * 更新單個市場的價格\n   */\n  async updateMarketPrice(marketId: string): Promise<void> {\n    try {\n      // 從 Oracle 聚合器獲取價格\n      const aggregationResult = await oracleAggregator.aggregatePrice(marketId);\n\n      // 轉換為 0-1 範圍的價格\n      const yesPrice = this.normalizePrice(aggregationResult.medianPrice);\n      const noPrice = 1 - yesPrice;\n\n      // 創建價格更新\n      const update: PriceUpdate = {\n        marketId,\n        timestamp: Date.now(),\n        yesPrice,\n        noPrice,\n        confidence: aggregationResult.confidence,\n        sources: aggregationResult.sources,\n      };\n\n      // 記錄價格歷史\n      this.recordPriceHistory(marketId, update);\n\n      // 更新價格統計\n      this.updatePriceStats(marketId, update);\n\n      // 檢查告警\n      this.checkAlerts(marketId, update);\n\n      // 通知監聽器\n      this.notifyUpdateListeners(update);\n    } catch (error) {\n      console.error(`[Price Feeder] Error updating price for market ${marketId}:`, error);\n    }\n  }\n\n  /**\n   * 規範化價格（轉換為 0-1 範圍）\n   */\n  private normalizePrice(price: bigint): number {\n    // 假設價格是以 Wei 為單位（10^18）\n    // 轉換為 0-1 範圍\n    const priceInEth = Number(price) / 1e18;\n    return Math.min(Math.max(priceInEth, 0), 1);\n  }\n\n  /**\n   * 記錄價格歷史\n   */\n  private recordPriceHistory(marketId: string, update: PriceUpdate): void {\n    if (!this.priceHistory.has(marketId)) {\n      this.priceHistory.set(marketId, []);\n    }\n\n    const history = this.priceHistory.get(marketId)!;\n    history.push({\n      timestamp: update.timestamp,\n      yesPrice: update.yesPrice,\n      noPrice: update.noPrice,\n      volume24h: 0n, // TODO: 從交易引擎獲取\n      trades24h: 0, // TODO: 從交易引擎獲取\n    });\n\n    // 保持最大歷史大小\n    if (history.length > this.maxHistorySize) {\n      history.shift();\n    }\n  }\n\n  /**\n   * 更新價格統計\n   */\n  private updatePriceStats(marketId: string, update: PriceUpdate): void {\n    const history = this.priceHistory.get(marketId) || [];\n    if (history.length === 0) return;\n\n    // 計算 24 小時統計\n    const now = Date.now();\n    const oneDayAgo = now - 24 * 60 * 60 * 1000;\n    const last24h = history.filter((h) => h.timestamp >= oneDayAgo);\n\n    if (last24h.length === 0) {\n      return;\n    }\n\n    const prices = last24h.map((h) => h.yesPrice);\n    const high24h = Math.max(...prices);\n    const low24h = Math.min(...prices);\n    const firstPrice = last24h[0].yesPrice;\n    const currentPrice = update.yesPrice;\n    const change24h = currentPrice - firstPrice;\n    const changePercent24h = firstPrice !== 0 ? (change24h / firstPrice) * 100 : 0;\n\n    // 計算波動率（標準差）\n    const mean = prices.reduce((a, b) => a + b, 0) / prices.length;\n    const variance = prices.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / prices.length;\n    const volatility = Math.sqrt(variance);\n\n    // 計算平均價格\n    const averagePrice = mean;\n\n    const stats: PriceStats = {\n      currentPrice,\n      high24h,\n      low24h,\n      change24h,\n      changePercent24h,\n      volatility,\n      averagePrice,\n    };\n\n    this.priceStats.set(marketId, stats);\n  }\n\n  /**\n   * 檢查告警\n   */\n  private checkAlerts(marketId: string, update: PriceUpdate): void {\n    const alerts = this.priceAlerts.get(marketId) || [];\n    const stats = this.priceStats.get(marketId);\n\n    if (!stats) return;\n\n    for (const alert of alerts) {\n      let shouldTrigger = false;\n\n      switch (alert.type) {\n        case 'high':\n          shouldTrigger = update.yesPrice >= alert.threshold;\n          break;\n        case 'low':\n          shouldTrigger = update.yesPrice <= alert.threshold;\n          break;\n        case 'volatility':\n          shouldTrigger = stats.volatility >= alert.threshold;\n          break;\n        case 'confidence':\n          shouldTrigger = update.confidence <= alert.threshold;\n          break;\n      }\n\n      if (shouldTrigger && !alert.triggered) {\n        alert.triggered = true;\n        alert.triggeredAt = Date.now();\n        this.notifyAlertListeners(alert);\n      } else if (!shouldTrigger && alert.triggered) {\n        alert.triggered = false;\n        alert.triggeredAt = undefined;\n      }\n    }\n  }\n\n  /**\n   * 添加價格告警\n   */\n  addAlert(\n    marketId: string,\n    type: 'high' | 'low' | 'volatility' | 'confidence',\n    threshold: number\n  ): string {\n    if (!this.priceAlerts.has(marketId)) {\n      this.priceAlerts.set(marketId, []);\n    }\n\n    const alertId = `${marketId}-${type}-${threshold}-${Date.now()}`;\n    const alert: PriceAlert = {\n      id: alertId,\n      marketId,\n      type,\n      threshold,\n      triggered: false,\n    };\n\n    this.priceAlerts.get(marketId)!.push(alert);\n    return alertId;\n  }\n\n  /**\n   * 移除價格告警\n   */\n  removeAlert(marketId: string, alertId: string): boolean {\n    const alerts = this.priceAlerts.get(marketId);\n    if (!alerts) return false;\n\n    const index = alerts.findIndex((a) => a.id === alertId);\n    if (index === -1) return false;\n\n    alerts.splice(index, 1);\n    return true;\n  }\n\n  /**\n   * 獲取價格統計\n   */\n  getPriceStats(marketId: string): PriceStats | null {\n    return this.priceStats.get(marketId) || null;\n  }\n\n  /**\n   * 獲取價格歷史\n   */\n  getPriceHistory(marketId: string, limit?: number): PriceHistory[] {\n    const history = this.priceHistory.get(marketId) || [];\n    if (!limit) return history;\n    return history.slice(-limit);\n  }\n\n  /**\n   * 獲取市場告警\n   */\n  getAlerts(marketId: string): PriceAlert[] {\n    return this.priceAlerts.get(marketId) || [];\n  }\n\n  /**\n   * 註冊價格更新監聽器\n   */\n  onPriceUpdate(listener: (update: PriceUpdate) => void): void {\n    this.updateListeners.push(listener);\n  }\n\n  /**\n   * 移除價格更新監聽器\n   */\n  offPriceUpdate(listener: (update: PriceUpdate) => void): void {\n    const index = this.updateListeners.indexOf(listener);\n    if (index !== -1) {\n      this.updateListeners.splice(index, 1);\n    }\n  }\n\n  /**\n   * 註冊告警監聽器\n   */\n  onAlert(listener: (alert: PriceAlert) => void): void {\n    this.alertListeners.push(listener);\n  }\n\n  /**\n   * 移除告警監聽器\n   */\n  offAlert(listener: (alert: PriceAlert) => void): void {\n    const index = this.alertListeners.indexOf(listener);\n    if (index !== -1) {\n      this.alertListeners.splice(index, 1);\n    }\n  }\n\n  /**\n   * 通知價格更新監聽器\n   */\n  private notifyUpdateListeners(update: PriceUpdate): void {\n    for (const listener of this.updateListeners) {\n      try {\n        listener(update);\n      } catch (error) {\n        console.error('[Price Feeder] Error in update listener:', error);\n      }\n    }\n  }\n\n  /**\n   * 通知告警監聽器\n   */\n  private notifyAlertListeners(alert: PriceAlert): void {\n    for (const listener of this.alertListeners) {\n      try {\n        listener(alert);\n      } catch (error) {\n        console.error('[Price Feeder] Error in alert listener:', error);\n      }\n    }\n  }\n\n  /**\n   * 初始化市場\n   */\n  initializeMarket(marketId: string): void {\n    if (!this.priceHistory.has(marketId)) {\n      this.priceHistory.set(marketId, []);\n    }\n    if (!this.priceAlerts.has(marketId)) {\n      this.priceAlerts.set(marketId, []);\n    }\n  }\n\n  /**\n   * 獲取統計信息\n   */\n  getStats() {\n    return {\n      markets: this.priceHistory.size,\n      totalAlerts: Array.from(this.priceAlerts.values()).reduce((sum, alerts) => sum + alerts.length, 0),\n      activeAlerts: Array.from(this.priceAlerts.values()).reduce(\n        (sum, alerts) => sum + alerts.filter((a) => a.triggered).length,\n        0\n      ),\n      historySize: Array.from(this.priceHistory.values()).reduce((sum, history) => sum + history.length, 0),\n    };\n  }\n}\n\n// 導出單例\nconst priceFeeder = new PriceFeeder();\n\nexport default priceFeeder;\nexport type { PriceUpdate, PriceHistory, PriceStats, PriceAlert };\n
